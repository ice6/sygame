<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="æ—‹è½¬æœ¨é©¬">
<link rel="manifest" href="manifest.json">
<title>ğŸ‘¦ æ•°å­—æ’åºæ¸¸æˆ</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Noto+Sans+SC:wght@400;700;900&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

:root {
  --sky: #87CEEB;
  --grass: #4CAF50;
  --road: #333;
  --sun: #FFD700;
  --pink: #FF6B9D;
  --orange: #FF9800;
  --purple: #9C27B0;
  --blue: #2196F3;
  --green: #4CAF50;
}

body {
  font-family: 'Fredoka', 'Noto Sans SC', sans-serif;
  overflow: hidden;
  height: 100vh;
  width: 100vw;
  background: var(--sky);
  touch-action: manipulation;
}

/* ====== SCENE BACKGROUND ====== */
.scene {
  position: fixed;
  inset: 0;
  overflow: hidden;
  z-index: 0;
}

/* Sky gradient */
.sky {
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, #4FC3F7 0%, #81D4FA 30%, #B3E5FC 60%, #E1F5FE 100%);
}

/* Clouds */
.cloud {
  position: absolute;
  background: white;
  border-radius: 50px;
  opacity: 0.9;
  animation: float-cloud linear infinite;
}
.cloud::before, .cloud::after {
  content: '';
  position: absolute;
  background: white;
  border-radius: 50%;
}
.cloud-1 { width: 120px; height: 40px; top: 8%; left: -150px; animation-duration: 25s; }
.cloud-1::before { width: 50px; height: 50px; top: -25px; left: 20px; }
.cloud-1::after { width: 70px; height: 60px; top: -30px; left: 50px; }
.cloud-2 { width: 90px; height: 30px; top: 15%; left: -120px; animation-duration: 35s; animation-delay: 5s; }
.cloud-2::before { width: 40px; height: 40px; top: -20px; left: 15px; }
.cloud-2::after { width: 55px; height: 45px; top: -22px; left: 40px; }
.cloud-3 { width: 140px; height: 45px; top: 5%; left: -170px; animation-duration: 30s; animation-delay: 12s; }
.cloud-3::before { width: 60px; height: 55px; top: -28px; left: 25px; }
.cloud-3::after { width: 80px; height: 65px; top: -32px; left: 60px; }

@keyframes float-cloud {
  from { transform: translateX(0); }
  to { transform: translateX(calc(100vw + 200px)); }
}

/* Sun */
.sun {
  position: absolute;
  width: 80px; height: 80px;
  background: radial-gradient(circle, #FFF176, #FFD54F, #FFB300);
  border-radius: 50%;
  top: 5%;
  right: 10%;
  box-shadow: 0 0 40px #FFD54F, 0 0 80px rgba(255,213,79,0.4);
  animation: pulse-sun 3s ease-in-out infinite;
}
@keyframes pulse-sun {
  0%, 100% { transform: scale(1); box-shadow: 0 0 40px #FFD54F, 0 0 80px rgba(255,213,79,0.4); }
  50% { transform: scale(1.05); box-shadow: 0 0 60px #FFD54F, 0 0 100px rgba(255,213,79,0.5); }
}

/* City skyline */
.buildings {
  position: absolute;
  bottom: 28%;
  left: 0; right: 0;
  height: 200px;
  display: flex;
  align-items: flex-end;
  justify-content: space-around;
  padding: 0 20px;
}
.building {
  position: relative;
  border-radius: 8px 8px 0 0;
}
.building-1 { width: 60px; height: 140px; background: linear-gradient(135deg, #EF5350, #E53935); }
.building-2 { width: 80px; height: 180px; background: linear-gradient(135deg, #AB47BC, #8E24AA); }
.building-3 { width: 70px; height: 120px; background: linear-gradient(135deg, #42A5F5, #1E88E5); }
.building-4 { width: 90px; height: 160px; background: linear-gradient(135deg, #66BB6A, #43A047); }
.building-5 { width: 55px; height: 100px; background: linear-gradient(135deg, #FFA726, #FB8C00); }
.building-6 { width: 75px; height: 150px; background: linear-gradient(135deg, #EC407A, #D81B60); }
.building-windows {
  position: absolute;
  inset: 10px 8px;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
}
.window {
  background: rgba(255,255,200,0.7);
  border-radius: 2px;
  animation: twinkle 2s ease-in-out infinite;
}
.window:nth-child(odd) { animation-delay: 0.5s; }
.window:nth-child(3n) { animation-delay: 1s; }
@keyframes twinkle {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; background: rgba(255,255,150,1); }
}

/* Office building */
.office {
  position: absolute;
  bottom: 28%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1;
}
.office-top {
  background: #37474F;
  color: white;
  padding: 8px 30px;
  border-radius: 8px 8px 0 0;
  text-align: center;
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 3px;
}
.office-body {
  width: 140px;
  height: 100px;
  background: linear-gradient(180deg, #ECEFF1, #CFD8DC);
  border-radius: 0 0 4px 4px;
}

/* Trees */
.trees {
  position: absolute;
  bottom: 22%;
  left: 0; right: 0;
  height: 80px;
}
.tree {
  position: absolute;
  bottom: 0;
}
.tree-trunk {
  width: 8px;
  height: 30px;
  background: #795548;
  margin: 0 auto;
  border-radius: 2px;
}
.tree-top {
  width: 40px;
  height: 40px;
  background: radial-gradient(circle, #66BB6A, #2E7D32);
  border-radius: 50%;
  margin: 0 auto;
  margin-bottom: -5px;
}
.tree:nth-child(1) { left: 5%; }
.tree:nth-child(2) { left: 15%; }
.tree:nth-child(3) { left: 30%; }
.tree:nth-child(4) { left: 55%; }
.tree:nth-child(5) { left: 70%; }
.tree:nth-child(6) { left: 85%; }
.tree:nth-child(7) { left: 92%; }

/* Road */
.road {
  position: absolute;
  bottom: 16%;
  left: 0; right: 0;
  height: 60px;
  background: #424242;
  border-top: 4px solid #9E9E9E;
  border-bottom: 4px solid #9E9E9E;
}
.road-line {
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 4px;
  transform: translateY(-50%);
  background: repeating-linear-gradient(90deg, #FFF 0, #FFF 30px, transparent 30px, transparent 60px);
}

/* Car */
.car {
  position: absolute;
  bottom: 18%;
  width: 70px; height: 35px;
  animation: drive 12s linear infinite;
}
.car-body {
  width: 100%; height: 100%;
  background: #FFD54F;
  border-radius: 10px 20px 5px 5px;
  position: relative;
}
.car-window {
  position: absolute;
  top: 5px; left: 30px;
  width: 25px; height: 15px;
  background: rgba(100,200,255,0.7);
  border-radius: 5px 8px 0 0;
}
.car-wheel {
  position: absolute;
  bottom: -5px;
  width: 14px; height: 14px;
  background: #333;
  border-radius: 50%;
}
.car-wheel-front { right: 8px; }
.car-wheel-rear { left: 8px; }
@keyframes drive {
  from { left: -100px; }
  to { left: calc(100% + 100px); }
}

/* Grass */
.grass {
  position: absolute;
  bottom: 0;
  left: 0; right: 0;
  height: 16%;
  background: linear-gradient(180deg, #66BB6A, #4CAF50, #388E3C);
}

/* ====== GAME UI ====== */
.game-container {
  position: relative;
  z-index: 10;
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 10px 15px;
}

/* Title */
.game-title {
  font-size: clamp(44px, 4vw, 72px);
  font-weight: 700;
  color: #fff;
  text-shadow: 3px 3px 0 #E91E63, -1px -1px 0 #E91E63, 1px -1px 0 #E91E63, -1px 1px 0 #E91E63;
  margin-bottom: 5px;
  letter-spacing: 4px;
  animation: bounce-title 2s ease-in-out infinite;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  width: clamp(360px, 80vw, 570px);
  background: linear-gradient(135deg, rgba(255,107,157,0.85), rgba(233,30,99,0.85));
  padding: 12px 25px;
  border-radius: 20px;
  border: 4px solid #fff;
  box-shadow: 0 6px 20px rgba(233,30,99,0.4), inset 0 2px 4px rgba(255,255,255,0.3);
}
.title-icon {
  width: clamp(40px, 8vw, 60px);
  height: auto;
}
@keyframes bounce-title {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

/* Mode & Difficulty selectors */
.controls-row {
  display: flex;
  gap: 10px;
  margin-bottom: 8px;
  flex-wrap: wrap;
  justify-content: center;
}
.control-btn {
  padding: 6px 16px;
  border: 3px solid #fff;
  border-radius: 25px;
  background: rgba(255,255,255,0.3);
  color: #fff;
  font-family: inherit;
  font-size: clamp(12px, 2vw, 16px);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  backdrop-filter: blur(5px);
  text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}
.control-btn.active {
  background: #E91E63;
  border-color: #E91E63;
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(233,30,99,0.4);
}
.control-btn:hover { transform: scale(1.05); }

/* Game status row */
.game-status-row {
  display: flex;
  gap: 20px;
  align-items: center;
  margin-bottom: 8px;
  min-height: 30px;
}

.timer-section {
  display: none;
  align-items: center;
  gap: 8px;
}
.timer-section.active { display: flex; }

.timer-bar {
  width: 120px;
  height: 12px;
  background: rgba(255,255,255,0.3);
  border-radius: 6px;
  overflow: hidden;
  border: 2px solid #fff;
}
.timer-fill {
  height: 100%;
  width: 100%;
  background: linear-gradient(90deg, #4CAF50, #8BC34A);
  border-radius: 4px;
  transition: width 0.1s linear;
}
.timer-fill.warning { background: linear-gradient(90deg, #FF9800, #FFC107); }
.timer-fill.danger { background: linear-gradient(90deg, #F44336, #E91E63); animation: pulse-danger 0.5s ease-in-out infinite; }
@keyframes pulse-danger {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}
.timer-text {
  color: #fff;
  font-weight: 700;
  font-size: 16px;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
  min-width: 35px;
}

.lives-section {
  display: none;
  gap: 4px;
}
.lives-section.active { display: flex; }
.life-heart {
  font-size: 24px;
  transition: all 0.3s;
}
.life-heart.lost {
  filter: grayscale(100%);
  opacity: 0.4;
  transform: scale(0.8);
}

/* Memory mode - hidden candidates */
.candidate.hidden-memory {
  background: linear-gradient(135deg, #9E9E9E, #757575);
  border-color: #616161;
  color: transparent;
  position: relative;
}
.candidate.hidden-memory::after {
  content: '?';
  position: absolute;
  color: #fff;
  font-size: inherit;
}

/* Game over overlay */
.game-over {
  position: fixed;
  inset: 0;
  z-index: 100;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.5);
}
.game-over.show { display: flex; }
.game-over-content {
  text-align: center;
  animation: celebrate-bounce 0.6s ease-out;
}
.game-over-emoji { font-size: 80px; }
.game-over-text {
  font-size: 32px;
  font-weight: 700;
  color: #fff;
  text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
  margin-top: 10px;
}
.game-over-sub {
  font-size: 18px;
  color: #FFCDD2;
  margin-top: 8px;
}
.retry-btn {
  margin-top: 20px;
  padding: 12px 40px;
  background: linear-gradient(135deg, #42A5F5, #1E88E5);
  border: none;
  border-radius: 30px;
  color: white;
  font-family: inherit;
  font-size: 20px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(33,150,243,0.4);
  transition: transform 0.2s;
}
.retry-btn:hover { transform: scale(1.1); }

/* Spinner area */
.spinner-section {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 10px;
}

.spinner-box {
  width: 80px;
  height: 90px;
  background: rgba(255,255,255,0.95);
  border: 4px solid #1565C0;
  border-radius: 15px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}
.spinner-track {
  position: absolute;
  width: 100%;
  transition: transform 0.1s linear;
}
.spinner-num {
  width: 100%;
  height: 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: 700;
  color: #1565C0;
}

.spin-btn {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, #FF6B9D, #E91E63);
  color: white;
  font-family: inherit;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(233,30,99,0.4);
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  line-height: 1.2;
}
.spin-btn:hover { transform: scale(1.1); }
.spin-btn:active { transform: scale(0.95); }
.spin-btn.spinning {
  animation: wiggle 0.3s ease-in-out infinite;
  pointer-events: none;
}
@keyframes wiggle {
  0%, 100% { transform: rotate(0); }
  25% { transform: rotate(-5deg); }
  75% { transform: rotate(5deg); }
}

/* Direction indicator */
.direction-indicator {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
  padding: 6px 20px;
  background: rgba(255,255,255,0.85);
  border-radius: 30px;
  border: 3px solid #1565C0;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.dir-circle {
  width: 30px; height: 30px;
  border-radius: 50%;
  background: #2196F3;
  transition: all 0.3s;
}
.dir-circle.big { width: 40px; height: 40px; }
.dir-circle.small { width: 20px; height: 20px; }
.dir-arrow {
  font-size: 28px;
  color: #1565C0;
  font-weight: 700;
}

/* Carousel horses */
.carousel-section {
  width: 100%;
  max-width: 700px;
  margin-bottom: 8px;
  position: relative;
}
.carousel-bar {
  display: flex;
  justify-content: space-around;
  align-items: flex-end;
  height: 80px;
  position: relative;
}
.horse-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 16%;
}
.horse-pole {
  width: 4px;
  height: 25px;
  background: linear-gradient(180deg, #FFD700, #FFA000, #FFD700);
  border-radius: 2px;
}
.horse {
  font-size: clamp(30px, 5vw, 45px);
  animation: horse-bounce 1.5s ease-in-out infinite;
  cursor: default;
  filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.2));
}
.horse:nth-child(1) .horse { animation-delay: 0s; }
.horse-container:nth-child(2) .horse { animation-delay: 0.25s; }
.horse-container:nth-child(3) .horse { animation-delay: 0.5s; }
.horse-container:nth-child(4) .horse { animation-delay: 0.75s; }
.horse-container:nth-child(5) .horse { animation-delay: 1.0s; }
.horse-container:nth-child(6) .horse { animation-delay: 1.25s; }

@keyframes horse-bounce {
  0%, 100% { transform: translateY(0) rotate(-3deg); }
  50% { transform: translateY(-10px) rotate(3deg); }
}

/* Answer slots */
.slots-section {
  display: flex;
  gap: clamp(6px, 1.5vw, 12px);
  margin-bottom: 8px;
  width: 100%;
  max-width: 700px;
  justify-content: center;
}
.slot {
  width: clamp(55px, 12vw, 85px);
  height: clamp(60px, 13vw, 90px);
  background: rgba(255,255,255,0.95);
  border: 3px solid #1565C0;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(24px, 5vw, 40px);
  font-weight: 700;
  color: #1565C0;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  transition: all 0.3s;
  position: relative;
}
.slot.first-slot {
  background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
  border-color: #0D47A1;
  color: #0D47A1;
}
.slot.filled {
  background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
  border-color: #2E7D32;
  color: #2E7D32;
  animation: pop-in 0.3s ease-out;
}
.slot.wrong {
  background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
  border-color: #C62828;
  color: #C62828;
  animation: shake 0.5s ease-out;
}
.slot.drop-target {
  border-color: #FF6B9D;
  border-style: dashed;
  background: rgba(255,107,157,0.1);
  transform: scale(1.05);
}
@keyframes pop-in {
  0% { transform: scale(0.5); }
  60% { transform: scale(1.15); }
  100% { transform: scale(1); }
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-8px); }
  40% { transform: translateX(8px); }
  60% { transform: translateX(-5px); }
  80% { transform: translateX(5px); }
}

/* Candidate numbers */
.candidates-section {
  display: flex;
  gap: clamp(6px, 1.5vw, 12px);
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 10px;
  min-height: 60px;
}
.candidate {
  width: clamp(45px, 10vw, 65px);
  height: clamp(45px, 10vw, 65px);
  background: linear-gradient(135deg, #FFE082, #FFD54F);
  border: 3px solid #F57F17;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(22px, 4.5vw, 36px);
  font-weight: 700;
  color: #E65100;
  cursor: grab;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  user-select: none;
  -webkit-user-select: none;
  touch-action: none;
}
.candidate:hover { transform: scale(1.1) rotate(-3deg); }
.candidate:active { cursor: grabbing; transform: scale(1.15); }
.candidate.dragging {
  opacity: 0.5;
  transform: scale(0.9);
}
.candidate.used {
  opacity: 0.3;
  pointer-events: none;
  transform: scale(0.8);
}

/* Floating drag preview */
.drag-preview {
  position: fixed;
  width: 60px; height: 60px;
  background: linear-gradient(135deg, #FF8A65, #FF5722);
  border: 3px solid #BF360C;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  font-weight: 700;
  color: white;
  pointer-events: none;
  z-index: 1000;
  transform: translate(-50%, -50%) scale(1.2);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  display: none;
}

/* Feedback */
.feedback {
  font-size: clamp(16px, 3vw, 24px);
  font-weight: 700;
  color: #fff;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  min-height: 35px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Score */
.score-section {
  display: flex;
  gap: 20px;
  margin-bottom: 5px;
}
.score-item {
  padding: 4px 15px;
  background: rgba(255,255,255,0.3);
  border-radius: 20px;
  color: #fff;
  font-weight: 600;
  font-size: clamp(12px, 2vw, 16px);
  backdrop-filter: blur(5px);
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

/* Celebration overlay */
.celebration {
  position: fixed;
  inset: 0;
  z-index: 100;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.3);
}
.celebration.show { display: flex; }
.celebration-content {
  text-align: center;
  animation: celebrate-bounce 0.6s ease-out;
}
@keyframes celebrate-bounce {
  0% { transform: scale(0); }
  60% { transform: scale(1.2); }
  100% { transform: scale(1); }
}
.celebration-emoji {
  font-size: 80px;
  animation: spin-celebrate 1s ease-in-out infinite;
}
@keyframes spin-celebrate {
  0%, 100% { transform: rotate(0) scale(1); }
  50% { transform: rotate(10deg) scale(1.1); }
}
.celebration-text {
  font-size: 36px;
  font-weight: 700;
  color: #fff;
  text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
  margin-top: 10px;
}
.celebration-sub {
  font-size: 18px;
  color: #FFE082;
  margin-top: 8px;
}
.next-btn {
  margin-top: 20px;
  padding: 12px 40px;
  background: linear-gradient(135deg, #FF6B9D, #E91E63);
  border: none;
  border-radius: 30px;
  color: white;
  font-family: inherit;
  font-size: 20px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(233,30,99,0.4);
  transition: transform 0.2s;
}
.next-btn:hover { transform: scale(1.1); }

/* Confetti */
.confetti-piece {
  position: fixed;
  width: 10px;
  height: 10px;
  z-index: 101;
  animation: confetti-fall 3s ease-out forwards;
}
@keyframes confetti-fall {
  0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* Music control */
.music-btn {
  position: fixed;
  bottom: 15px;
  right: 15px;
  width: 45px; height: 45px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,0.8);
  font-size: 22px;
  cursor: pointer;
  z-index: 50;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  transition: transform 0.2s;
}
.music-btn:hover { transform: scale(1.1); }

/* Responsive adjustments for iPad */
@media (min-width: 768px) {
  .game-container { padding: 15px 30px; }
  .spinner-box { width: 100px; height: 110px; }
  .spinner-num { height: 110px; font-size: 60px; }
  .spin-btn { width: 85px; height: 85px; font-size: 16px; }
}

@media (max-height: 700px) {
  .carousel-bar { height: 60px; }
  .horse { font-size: 28px !important; }
  .horse-pole { height: 15px; }
  .slot { height: 55px !important; }
  .candidate { width: 42px !important; height: 42px !important; font-size: 20px !important; }
}
</style>
</head>
<body>

<!-- BACKGROUND SCENE -->
<div class="scene">
  <div class="sky"></div>
  <div class="sun"></div>
  <div class="cloud cloud-1"></div>
  <div class="cloud cloud-2"></div>
  <div class="cloud cloud-3"></div>
  <div class="buildings">
    <div class="building building-1"><div class="building-windows"><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div></div></div>
    <div class="building building-5"><div class="building-windows"><div class="window"></div><div class="window"></div><div class="window"></div></div></div>
    <div class="building building-3"><div class="building-windows"><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div></div></div>
    <div class="building building-4"><div class="building-windows"><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div></div></div>
    <div class="building building-6"><div class="building-windows"><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div></div></div>
    <div class="building building-2"><div class="building-windows"><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div></div></div>
  </div>
  <div class="trees">
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
  </div>
  <div class="road"><div class="road-line"></div></div>
  <div class="car">
    <div class="car-body">
      <div class="car-window"></div>
      <div class="car-wheel car-wheel-front"></div>
      <div class="car-wheel car-wheel-rear"></div>
    </div>
  </div>
  <div class="grass"></div>
</div>

<!-- GAME UI -->
<div class="game-container">
  <div class="game-title">
    <img src="happy-boy.png" alt="happy-boy" class="title-icon"> 
    6
  </div>
  
  <div class="score-section">
    <div class="score-item">â­ å¾—åˆ†: <span id="score">0</span></div>
    <div class="score-item">ğŸ¯ è¿å¯¹: <span id="streak">0</span></div>
  </div>

  <div class="controls-row">
    <button class="control-btn active" data-mode="desc" onclick="setMode('desc')">ä»å¤§åˆ°å° â†˜</button>
    <button class="control-btn" data-mode="asc" onclick="setMode('asc')">ä»å°åˆ°å¤§ â†—</button>
  </div>
  
  <div class="controls-row">
    <button class="control-btn active" data-diff="easy" onclick="setDifficulty('easy')">ç®€å• â­</button>
    <button class="control-btn" data-diff="medium" onclick="setDifficulty('medium')">ä¸­ç­‰ â­â­</button>
    <button class="control-btn" data-diff="hard" onclick="setDifficulty('hard')">å›°éš¾ â­â­â­</button>
    <button class="control-btn" data-diff="nightmare" onclick="setDifficulty('nightmare')">å™©æ¢¦ ğŸ’€</button>
  </div>

  <div class="game-status-row">
    <div class="timer-section" id="timerSection">
      <div class="timer-bar">
        <div class="timer-fill" id="timerFill"></div>
      </div>
      <span class="timer-text" id="timerText">30s</span>
    </div>
    <div class="lives-section" id="livesSection">
      <span class="life-heart">â¤ï¸</span>
      <span class="life-heart">â¤ï¸</span>
      <span class="life-heart">â¤ï¸</span>
    </div>
  </div>

  <div class="spinner-section">
    <div class="spinner-box">
      <div class="spinner-track" id="spinnerTrack"></div>
    </div>
    <button class="spin-btn" id="spinBtn" onclick="startSpin()">
      <span>ğŸ°</span>
      <span>è½¬!</span>
    </button>
  </div>

  <div class="direction-indicator">
    <div class="dir-circle" id="dirBig"></div>
    <div class="dir-arrow" id="dirArrow">â¡</div>
    <div class="dir-circle" id="dirSmall"></div>
  </div>

  <div class="carousel-section">
    <div class="carousel-bar" id="carouselBar"></div>
  </div>

  <div class="slots-section" id="slotsSection"></div>

  <div class="candidates-section" id="candidatesSection"></div>

  <div class="feedback" id="feedback"></div>
</div>

<!-- Celebration overlay -->
<div class="celebration" id="celebration">
  <div class="celebration-content">
    <div class="celebration-emoji">ğŸ‰</div>
    <div class="celebration-text">å¤ªæ£’äº†ï¼</div>
    <div class="celebration-sub" id="celebrationSub">å…¨éƒ¨ç­”å¯¹äº†ï¼</div>
    <button class="next-btn" onclick="nextRound()">ä¸‹ä¸€è½® â–¶</button>
  </div>
</div>

<!-- Game over overlay -->
<div class="game-over" id="gameOver">
  <div class="game-over-content">
    <div class="game-over-emoji">ğŸ˜¢</div>
    <div class="game-over-text" id="gameOverText">æ—¶é—´åˆ°ï¼</div>
    <div class="game-over-sub" id="gameOverSub">å†è¯•ä¸€æ¬¡å§ï¼</div>
    <button class="retry-btn" onclick="retryRound()">å†æ¥ä¸€æ¬¡ ğŸ”„</button>
  </div>
</div>

<!-- Drag preview -->
<div class="drag-preview" id="dragPreview"></div>

<!-- Music toggle -->
<button class="music-btn" id="musicBtn" onclick="toggleMusic()">ğŸ”‡</button>

<script>
// ====== GAME STATE ======
let mode = 'desc'; // desc = å¤§åˆ°å°, asc = å°åˆ°å¤§
let difficulty = 'easy'; // easy, medium, hard, nightmare
let firstNumber = null;
let firstPosition = 0; // èµ·å§‹æ•°å­—çš„ä½ç½® (0-5)
let isSpinning = false;
let filledSlots = [null, null, null, null, null, null]; // 6ä¸ªæ§½ä½
let score = 0;
let streak = 0;
let currentSlotIndex = 0;
let musicPlaying = false;
let audioCtx = null;

// æ–°å¢ï¼šéš¾åº¦ç›¸å…³çŠ¶æ€
let timeLeft = 30;
let timerInterval = null;
let lives = 3;
let gameActive = false;

// éš¾åº¦é…ç½®
const DIFFICULTY_CONFIG = {
  easy: { showAllNumbers: false, hasTimer: false, hasLives: false, memoryMode: false, timeLimit: 0 },
  medium: { showAllNumbers: true, hasTimer: false, hasLives: false, memoryMode: false, timeLimit: 0 },
  hard: { showAllNumbers: true, hasTimer: true, hasLives: false, memoryMode: false, timeLimit: 30 },
  nightmare: { showAllNumbers: true, hasTimer: true, hasLives: true, memoryMode: true, timeLimit: 25 }
};

// ====== INITIALIZATION ======
function init() {
  buildCarousel();
  buildSpinner();
  updateDirection();
  buildSlots();
  updateDifficultyUI();
  updateFeedback('ç‚¹å‡» ğŸ° æŒ‰é’®å¼€å§‹æ¸¸æˆï¼', 'ğŸ®');
}

// ====== MODE & DIFFICULTY ======
function setMode(m) {
  mode = m;
  document.querySelectorAll('[data-mode]').forEach(b => b.classList.toggle('active', b.dataset.mode === m));
  updateDirection();
  resetRound();
}

function setDifficulty(d) {
  difficulty = d;
  document.querySelectorAll('[data-diff]').forEach(b => b.classList.toggle('active', b.dataset.diff === d));
  updateDifficultyUI();
  resetRound();
}

function updateDifficultyUI() {
  const config = DIFFICULTY_CONFIG[difficulty];
  const timerSection = document.getElementById('timerSection');
  const livesSection = document.getElementById('livesSection');
  
  timerSection.classList.toggle('active', config.hasTimer);
  livesSection.classList.toggle('active', config.hasLives);
  
  // é‡ç½®æ˜¾ç¤º
  document.getElementById('timerFill').style.width = '100%';
  document.getElementById('timerFill').className = 'timer-fill';
  document.getElementById('timerText').textContent = (config.timeLimit || 30) + 's';
  updateLivesDisplay(3);
}

function updateLivesDisplay(count) {
  const hearts = document.querySelectorAll('.life-heart');
  hearts.forEach((h, i) => {
    h.classList.toggle('lost', i >= count);
  });
}

function updateDirection() {
  const big = document.getElementById('dirBig');
  const small = document.getElementById('dirSmall');
  if (mode === 'desc') {
    big.classList.add('big'); big.classList.remove('small');
    small.classList.add('small'); small.classList.remove('big');
  } else {
    big.classList.add('small'); big.classList.remove('big');
    small.classList.add('big'); small.classList.remove('small');
  }
}

// ====== CAROUSEL HORSES ======
function buildCarousel() {
  const bar = document.getElementById('carouselBar');
  const horses = ['ğŸ´', 'ğŸ¦„', 'ğŸ', 'ğŸ´', 'ğŸ¦„', 'ğŸ'];
  const colors = ['#FF6B9D', '#9C27B0', '#FF9800', '#4CAF50', '#2196F3', '#E91E63'];
  bar.innerHTML = horses.map((h, i) => `
    <div class="horse-container">
      <div class="horse" style="animation-delay: ${i * 0.25}s; color: ${colors[i]}">${h}</div>
      <div class="horse-pole"></div>
    </div>
  `).join('');
}

// ====== SPINNER ======
function buildSpinner() {
  const track = document.getElementById('spinnerTrack');
  // Numbers 1-10 for the spinner
  const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
  track.innerHTML = nums.concat(nums).concat(nums).map(n => 
    `<div class="spinner-num">${n}</div>`
  ).join('');
}

function startSpin() {
  if (isSpinning) return;
  isSpinning = true;
  gameActive = false;
  stopTimer();
  
  const btn = document.getElementById('spinBtn');
  btn.classList.add('spinning');
  
  // Reset previous round
  filledSlots = [null, null, null, null, null, null];
  currentSlotIndex = 0;
  lives = 3;
  const config = DIFFICULTY_CONFIG[difficulty];
  timeLeft = config.timeLimit;
  updateLivesDisplay(3);
  
  playSound('spin');
  updateFeedback('è½¬åŠ¨ä¸­...', 'ğŸ°');
  
  // éšæœºé€‰æ‹©èµ·å§‹ä½ç½® (0-5)
  firstPosition = Math.floor(Math.random() * 6);
  
  // æ ¹æ®ä½ç½®å’Œæ¨¡å¼è®¡ç®—åˆé€‚çš„æ•°å­—èŒƒå›´
  // ä»å¤§åˆ°å°: å·¦è¾¹éœ€è¦æ›´å¤§çš„æ•°ï¼Œå³è¾¹éœ€è¦æ›´å°çš„æ•°
  // ä»å°åˆ°å¤§: å·¦è¾¹éœ€è¦æ›´å°çš„æ•°ï¼Œå³è¾¹éœ€è¦æ›´å¤§çš„æ•°
  const leftSlots = firstPosition; // å·¦è¾¹æœ‰å¤šå°‘ä¸ªç©ºä½
  const rightSlots = 5 - firstPosition; // å³è¾¹æœ‰å¤šå°‘ä¸ªç©ºä½
  
  let minNum, maxNum;
  if (mode === 'desc') {
    // ä»å¤§åˆ°å°: å·¦è¾¹æ”¾æ›´å¤§çš„æ•°ï¼Œå³è¾¹æ”¾æ›´å°çš„æ•°
    // æœ€å°å€¼: éœ€è¦å³è¾¹æœ‰rightSlotsä¸ªæ›´å°çš„æ•° (rightSlots + 1)
    // æœ€å¤§å€¼: éœ€è¦å·¦è¾¹æœ‰leftSlotsä¸ªæ›´å¤§çš„æ•° (10 - leftSlots)
    minNum = rightSlots + 1;
    maxNum = 10 - leftSlots;
  } else {
    // ä»å°åˆ°å¤§: å·¦è¾¹æ”¾æ›´å°çš„æ•°ï¼Œå³è¾¹æ”¾æ›´å¤§çš„æ•°
    // æœ€å°å€¼: éœ€è¦å·¦è¾¹æœ‰leftSlotsä¸ªæ›´å°çš„æ•° (leftSlots + 1)
    // æœ€å¤§å€¼: éœ€è¦å³è¾¹æœ‰rightSlotsä¸ªæ›´å¤§çš„æ•° (10 - rightSlots)
    minNum = leftSlots + 1;
    maxNum = 10 - rightSlots;
  }
  
  // ç”Ÿæˆå¯é€‰æ•°å­—åˆ—è¡¨
  const validNums = [];
  for (let i = minNum; i <= maxNum; i++) {
    validNums.push(i);
  }
  
  const track = document.getElementById('spinnerTrack');
  const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
  const targetNum = validNums[Math.floor(Math.random() * validNums.length)];
  const targetIdx = nums.indexOf(targetNum);
  const itemHeight = track.querySelector('.spinner-num').offsetHeight || 90;
  
  let currentOffset = 0;
  const totalItems = nums.length * 2 + targetIdx; // spin through 2 full cycles + land on target
  const totalDistance = totalItems * itemHeight;
  const duration = 2000;
  const startTime = performance.now();
  
  function animateSpin(now) {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed / duration, 1);
    // Ease out cubic
    const eased = 1 - Math.pow(1 - progress, 3);
    currentOffset = eased * totalDistance;
    track.style.transform = `translateY(-${currentOffset}px)`;
    
    if (progress < 1) {
      requestAnimationFrame(animateSpin);
    } else {
      // Land on target
      firstNumber = targetNum;
      isSpinning = false;
      btn.classList.remove('spinning');
      
      // Reset spinner position cleanly
      track.style.transform = `translateY(-${targetIdx * itemHeight}px)`;
      
      playSound('ding');
      updateFeedback(`èµ·å§‹æ•°å­—æ˜¯ ${targetNum}ï¼è¯·${mode === 'desc' ? 'ä»å¤§åˆ°å°' : 'ä»å°åˆ°å¤§'}æ’åˆ—`, 'âœ¨');
      
      buildSlots();
      buildCandidates();
      
      gameActive = true;
      
      // å¼€å§‹è®¡æ—¶å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
      if (config.hasTimer) {
        startTimer();
      }
      
      // è®°å¿†æ¨¡å¼
      if (config.memoryMode) {
        startMemoryMode();
      }
    }
  }
  requestAnimationFrame(animateSpin);
}

// ====== TIMER ======
function startTimer() {
  const config = DIFFICULTY_CONFIG[difficulty];
  timeLeft = config.timeLimit;
  updateTimerDisplay();
  
  timerInterval = setInterval(() => {
    if (!gameActive) return;
    
    timeLeft -= 0.1;
    updateTimerDisplay();
    
    if (timeLeft <= 0) {
      stopTimer();
      gameOver('time');
    }
  }, 100);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

function updateTimerDisplay() {
  const config = DIFFICULTY_CONFIG[difficulty];
  const fill = document.getElementById('timerFill');
  const text = document.getElementById('timerText');
  
  const percent = (timeLeft / config.timeLimit) * 100;
  fill.style.width = percent + '%';
  text.textContent = Math.ceil(timeLeft) + 's';
  
  fill.classList.remove('warning', 'danger');
  if (percent <= 20) {
    fill.classList.add('danger');
  } else if (percent <= 50) {
    fill.classList.add('warning');
  }
}

// ====== MEMORY MODE ======
function startMemoryMode() {
  updateFeedback('ğŸ§  è®°ä½æ•°å­—çš„ä½ç½®ï¼3ç§’åéšè—...', 'ğŸ‘€');
  
  setTimeout(() => {
    if (!gameActive) return;
    document.querySelectorAll('.candidate:not(.used)').forEach(c => {
      c.classList.add('hidden-memory');
    });
    updateFeedback(`è¯·${mode === 'desc' ? 'ä»å¤§åˆ°å°' : 'ä»å°åˆ°å¤§'}æ’åˆ—ï¼`, 'ğŸ¯');
  }, 3000);
}

function revealCandidate(el) {
  el.classList.remove('hidden-memory');
}

// ====== GAME OVER ======
function gameOver(reason) {
  gameActive = false;
  stopTimer();
  
  const overlay = document.getElementById('gameOver');
  const text = document.getElementById('gameOverText');
  const sub = document.getElementById('gameOverSub');
  
  if (reason === 'time') {
    text.textContent = 'â° æ—¶é—´åˆ°ï¼';
    sub.textContent = 'ä¸‹æ¬¡è¦æ›´å¿«å“¦ï¼';
    playSound('wrong');
  } else if (reason === 'lives') {
    text.textContent = 'ğŸ’” æœºä¼šç”¨å®Œäº†ï¼';
    sub.textContent = 'å†ä»”ç»†æƒ³æƒ³å§ï¼';
    playSound('wrong');
  }
  
  streak = 0;
  document.getElementById('streak').textContent = streak;
  
  overlay.classList.add('show');
}

function retryRound() {
  document.getElementById('gameOver').classList.remove('show');
  resetRound();
}

// ====== SLOTS ======
function buildSlots() {
  const section = document.getElementById('slotsSection');
  section.innerHTML = '';
  
  for (let i = 0; i < 6; i++) {
    const slot = document.createElement('div');
    slot.className = 'slot' + (i === firstPosition && firstNumber !== null ? ' first-slot' : '');
    slot.dataset.index = i;
    
    if (i === firstPosition && firstNumber !== null) {
      slot.textContent = firstNumber;
      slot.classList.add('filled');
      filledSlots[i] = firstNumber;
    }
    
    // Drop target events for empty slots
    if (i !== firstPosition || firstNumber === null) {
      slot.addEventListener('dragover', handleDragOver);
      slot.addEventListener('drop', handleDrop);
      slot.addEventListener('dragenter', handleDragEnter);
      slot.addEventListener('dragleave', handleDragLeave);
    }
    
    section.appendChild(slot);
  }
}

// ====== CANDIDATES ======
function buildCandidates() {
  if (firstNumber === null) return;
  
  const section = document.getElementById('candidatesSection');
  section.innerHTML = '';
  
  // è®¡ç®—æ‰€æœ‰éœ€è¦å¡«å…¥çš„æ­£ç¡®æ•°å­—
  let correctAnswers = [];
  
  if (mode === 'desc') {
    // ä»å¤§åˆ°å°ï¼šå·¦è¾¹æ˜¯æ›´å¤§çš„æ•°ï¼Œå³è¾¹æ˜¯æ›´å°çš„æ•°
    // å·¦è¾¹çš„æ•°å­—ï¼ˆä½ç½®0åˆ°firstPosition-1ï¼‰
    for (let i = 0; i < firstPosition; i++) {
      correctAnswers.push(firstNumber + (firstPosition - i));
    }
    // å³è¾¹çš„æ•°å­—ï¼ˆä½ç½®firstPosition+1åˆ°5ï¼‰
    for (let i = firstPosition + 1; i < 6; i++) {
      correctAnswers.push(firstNumber - (i - firstPosition));
    }
  } else {
    // ä»å°åˆ°å¤§ï¼šå·¦è¾¹æ˜¯æ›´å°çš„æ•°ï¼Œå³è¾¹æ˜¯æ›´å¤§çš„æ•°
    // å·¦è¾¹çš„æ•°å­—ï¼ˆä½ç½®0åˆ°firstPosition-1ï¼‰
    for (let i = 0; i < firstPosition; i++) {
      correctAnswers.push(firstNumber - (firstPosition - i));
    }
    // å³è¾¹çš„æ•°å­—ï¼ˆä½ç½®firstPosition+1åˆ°5ï¼‰
    for (let i = firstPosition + 1; i < 6; i++) {
      correctAnswers.push(firstNumber + (i - firstPosition));
    }
  }
  
  let candidates;
  const config = DIFFICULTY_CONFIG[difficulty];
  if (!config.showAllNumbers) {
    // Only show the 5 correct answers, shuffled
    candidates = [...correctAnswers];
  } else {
    // Show 1-10 range
    candidates = [];
    for (let i = 1; i <= 10; i++) {
      if (i !== firstNumber) candidates.push(i);
    }
  }
  
  // Shuffle
  for (let i = candidates.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
  }
  
  candidates.forEach(num => {
    const el = document.createElement('div');
    el.className = 'candidate';
    el.textContent = num;
    el.dataset.value = num;
    el.draggable = true;
    
    // Desktop drag
    el.addEventListener('dragstart', handleDragStart);
    el.addEventListener('dragend', handleDragEnd);
    
    // Touch drag
    el.addEventListener('touchstart', handleTouchStart, { passive: false });
    el.addEventListener('touchmove', handleTouchMove, { passive: false });
    el.addEventListener('touchend', handleTouchEnd, { passive: false });
    
    // Click to auto-fill next slot
    el.addEventListener('click', () => handleCandidateClick(el));
    
    section.appendChild(el);
  });
}

// ====== DRAG & DROP (Desktop) ======
let draggedValue = null;
let draggedEl = null;

function handleDragStart(e) {
  if (!gameActive) return;
  draggedValue = parseInt(e.target.dataset.value);
  draggedEl = e.target;
  e.target.classList.add('dragging');
  if (DIFFICULTY_CONFIG[difficulty].memoryMode) revealCandidate(e.target);
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
  e.target.classList.remove('dragging');
  document.querySelectorAll('.slot').forEach(s => s.classList.remove('drop-target'));
}

function handleDragOver(e) {
  e.preventDefault();
}

function handleDragEnter(e) {
  const slot = e.target.closest('.slot');
  if (slot && !slot.classList.contains('filled')) {
    slot.classList.add('drop-target');
  }
}

function handleDragLeave(e) {
  const slot = e.target.closest('.slot');
  if (slot) slot.classList.remove('drop-target');
}

function handleDrop(e) {
  e.preventDefault();
  if (!gameActive) return;
  const slot = e.target.closest('.slot');
  if (!slot) return;
  slot.classList.remove('drop-target');
  
  const slotIdx = parseInt(slot.dataset.index);
  // æ‹–åŠ¨å¯ä»¥æ”¾åˆ°ä»»æ„ç©ºæ§½ä½ï¼Œä¸é™é¡ºåº
  if (filledSlots[slotIdx] === null && draggedValue !== null) {
    placeNumberAtSlot(draggedValue, draggedEl, slotIdx);
  }
}

// ====== TOUCH DRAG (Mobile/iPad) ======
let touchDragEl = null;
let touchDragValue = null;
let touchStartX = 0;
let touchStartY = 0;

function handleTouchStart(e) {
  if (!gameActive) return;
  e.preventDefault();
  const el = e.target.closest('.candidate');
  if (!el || el.classList.contains('used')) return;
  
  touchDragEl = el;
  touchDragValue = parseInt(el.dataset.value);
  el.classList.add('dragging');
  if (DIFFICULTY_CONFIG[difficulty].memoryMode) revealCandidate(el);
  
  const touch = e.touches[0];
  touchStartX = touch.clientX;
  touchStartY = touch.clientY;
  
  const preview = document.getElementById('dragPreview');
  preview.textContent = touchDragValue;
  preview.style.display = 'flex';
  preview.style.left = touch.clientX + 'px';
  preview.style.top = touch.clientY + 'px';
}

function handleTouchMove(e) {
  e.preventDefault();
  if (!touchDragEl) return;
  
  const touch = e.touches[0];
  const preview = document.getElementById('dragPreview');
  preview.style.left = touch.clientX + 'px';
  preview.style.top = touch.clientY + 'px';
  
  // Highlight slot under finger - æ‹–åŠ¨å¯ä»¥é«˜äº®ä»»æ„ç©ºæ§½ä½
  const slotEl = document.elementFromPoint(touch.clientX, touch.clientY);
  document.querySelectorAll('.slot').forEach(s => s.classList.remove('drop-target'));
  if (slotEl) {
    const slot = slotEl.closest('.slot');
    if (slot && !slot.classList.contains('filled')) {
      slot.classList.add('drop-target');
    }
  }
}

function handleTouchEnd(e) {
  e.preventDefault();
  if (!touchDragEl) return;
  
  const preview = document.getElementById('dragPreview');
  
  // å…ˆè·å–è§¦æ‘¸ä½ç½®å’Œç›®æ ‡å…ƒç´ ï¼Œå†éšè—é¢„è§ˆ
  const touch = e.changedTouches[0];
  const dx = Math.abs(touch.clientX - touchStartX);
  const dy = Math.abs(touch.clientY - touchStartY);
  
  // ä¸´æ—¶éšè—é¢„è§ˆä»¥è·å–ä¸‹æ–¹å…ƒç´ 
  preview.style.visibility = 'hidden';
  const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);
  preview.style.visibility = '';
  preview.style.display = 'none';
  
  touchDragEl.classList.remove('dragging');
  document.querySelectorAll('.slot').forEach(s => s.classList.remove('drop-target'));
  
  if (dx < 10 && dy < 10) {
    // It's a tap - ç‚¹å‡»æŒ‰é¡ºåºå¡«ç©º
    handleCandidateClick(touchDragEl);
  } else if (gameActive) {
    // æ‹–åŠ¨å¯ä»¥æ”¾åˆ°ä»»æ„ç©ºæ§½ä½
    if (targetEl) {
      const slot = targetEl.closest('.slot');
      if (slot) {
        const slotIdx = parseInt(slot.dataset.index);
        if (filledSlots[slotIdx] === null) {
          placeNumberAtSlot(touchDragValue, touchDragEl, slotIdx);
        }
      }
    }
  }
  
  touchDragEl = null;
  touchDragValue = null;
}

// ====== CLICK TO PLACE ======
function handleCandidateClick(el) {
  if (!gameActive || el.classList.contains('used')) return;
  if (DIFFICULTY_CONFIG[difficulty].memoryMode) revealCandidate(el);
  const value = parseInt(el.dataset.value);
  placeNumber(value, el);
}

// ====== PLACE NUMBER LOGIC ======
// ç‚¹å‡»ç­”é¢˜ï¼šæŒ‰é¡ºåºå¡«ç©º
function placeNumber(value, candidateEl) {
  if (!gameActive) return;
  if (firstNumber === null) return;
  
  // Find next empty slot (æŒ‰é¡ºåº)
  let nextSlot = -1;
  for (let i = 0; i < 6; i++) {
    if (filledSlots[i] === null) { nextSlot = i; break; }
  }
  if (nextSlot === -1) return;
  
  placeNumberAtSlot(value, candidateEl, nextSlot);
}

// æ‹–åŠ¨ç­”é¢˜ï¼šæ”¾åˆ°æŒ‡å®šæ§½ä½
function placeNumberAtSlot(value, candidateEl, targetSlot) {
  if (!gameActive) return;
  if (firstNumber === null) return;
  if (targetSlot < 0 || targetSlot >= 6) return;
  if (filledSlots[targetSlot] !== null) return;
  
  // Calculate expected value based on position relative to firstPosition
  let expectedValue;
  if (mode === 'desc') {
    // ä»å¤§åˆ°å°ï¼šå·¦è¾¹æ›´å¤§ï¼Œå³è¾¹æ›´å°
    if (targetSlot < firstPosition) {
      expectedValue = firstNumber + (firstPosition - targetSlot);
    } else {
      expectedValue = firstNumber - (targetSlot - firstPosition);
    }
  } else {
    // ä»å°åˆ°å¤§ï¼šå·¦è¾¹æ›´å°ï¼Œå³è¾¹æ›´å¤§
    if (targetSlot < firstPosition) {
      expectedValue = firstNumber - (firstPosition - targetSlot);
    } else {
      expectedValue = firstNumber + (targetSlot - firstPosition);
    }
  }
  
  const slotEl = document.querySelectorAll('.slot')[targetSlot];
  
  if (value === expectedValue) {
    // Correct!
    filledSlots[targetSlot] = value;
    slotEl.textContent = value;
    slotEl.classList.add('filled');
    candidateEl.classList.add('used');
    playSound('correct');
    
    // Check if all filled
    if (filledSlots.every(v => v !== null)) {
      // Win!
      stopTimer();
      let baseScore = 10 + streak * 2;
      // Time bonus for timer modes
      const config = DIFFICULTY_CONFIG[difficulty];
      if (config.hasTimer && timeLeft > 0) {
        baseScore += Math.floor(timeLeft / 2); // å‰©ä½™æ—¶é—´å¥–åŠ±
      }
      // Lives bonus for nightmare mode
      if (config.hasLives && lives > 0) {
        baseScore += lives * 3; // å‰©ä½™ç”Ÿå‘½å¥–åŠ±
      }
      score += baseScore;
      streak++;
      document.getElementById('score').textContent = score;
      document.getElementById('streak').textContent = streak;
      
      updateFeedback('ğŸ‰ å…¨éƒ¨æ­£ç¡®ï¼å¤ªæ£’äº†ï¼', 'ğŸŒŸ');
      playSound('win');
      
      setTimeout(() => showCelebration(), 500);
    } else {
      updateFeedback('âœ… æ­£ç¡®ï¼ç»§ç»­åŠ æ²¹ï¼', 'ğŸ‘');
    }
  } else {
    // Wrong!
    slotEl.classList.add('wrong');
    setTimeout(() => slotEl.classList.remove('wrong'), 600);
    streak = 0;
    document.getElementById('streak').textContent = streak;
    playSound('wrong');
    
    // Handle lives in nightmare mode
    const config = DIFFICULTY_CONFIG[difficulty];
    if (config.hasLives) {
      lives--;
      updateLivesDisplay();
      if (lives <= 0) {
        gameOver('lives');
        return;
      }
      updateFeedback(`âŒ é”™äº†ï¼è¿˜å‰© ${lives} æ¡å‘½ï¼`, 'ğŸ’”');
    } else {
      updateFeedback(`âŒ ä¸å¯¹å“¦ï¼Œå†æƒ³æƒ³ï¼`, 'ğŸ¤”');
    }
  }
}

// ====== CELEBRATION ======
function showCelebration() {
  const cel = document.getElementById('celebration');
  cel.classList.add('show');
  document.getElementById('celebrationSub').textContent = `å¾—åˆ†: ${score} â­ è¿å¯¹: ${streak} ğŸ¯`;
  
  // Confetti
  for (let i = 0; i < 30; i++) {
    const piece = document.createElement('div');
    piece.className = 'confetti-piece';
    piece.style.left = Math.random() * 100 + 'vw';
    piece.style.top = '-20px';
    piece.style.animationDelay = Math.random() * 1 + 's';
    piece.style.animationDuration = (2 + Math.random() * 2) + 's';
    piece.style.background = ['#FF6B9D','#FFD54F','#4CAF50','#2196F3','#9C27B0','#FF9800'][Math.floor(Math.random()*6)];
    piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
    piece.style.width = (6 + Math.random() * 8) + 'px';
    piece.style.height = (6 + Math.random() * 8) + 'px';
    document.body.appendChild(piece);
    setTimeout(() => piece.remove(), 4000);
  }
}

function nextRound() {
  document.getElementById('celebration').classList.remove('show');
  resetRound();
}

function resetRound() {
  firstNumber = null;
  firstPosition = 0;
  filledSlots = [null, null, null, null, null, null];
  currentSlotIndex = 0;
  buildSlots();
  document.getElementById('candidatesSection').innerHTML = '';
  updateFeedback('ç‚¹å‡» ğŸ° æŒ‰é’®å¼€å§‹æ–°ä¸€è½®ï¼', 'ğŸ®');
  
  // Reset spinner
  const track = document.getElementById('spinnerTrack');
  track.style.transform = 'translateY(0)';
}

// ====== FEEDBACK ======
function updateFeedback(text, emoji) {
  const fb = document.getElementById('feedback');
  fb.innerHTML = `<span>${emoji || ''}</span> ${text}`;
}

// ====== SOUND EFFECTS (Web Audio API) ======
function getAudioCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  return audioCtx;
}

function playSound(type) {
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    
    switch(type) {
      case 'spin':
        osc.frequency.value = 300;
        osc.frequency.linearRampToValueAtTime(800, ctx.currentTime + 0.3);
        gain.gain.value = 0.15;
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.5);
        osc.start();
        osc.stop(ctx.currentTime + 0.5);
        break;
      case 'ding':
        osc.frequency.value = 880;
        osc.type = 'sine';
        gain.gain.value = 0.2;
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.4);
        osc.start();
        osc.stop(ctx.currentTime + 0.4);
        break;
      case 'correct':
        osc.frequency.value = 523;
        osc.type = 'sine';
        gain.gain.value = 0.15;
        osc.start();
        setTimeout(() => {
          const osc2 = ctx.createOscillator();
          const gain2 = ctx.createGain();
          osc2.connect(gain2);
          gain2.connect(ctx.destination);
          osc2.frequency.value = 659;
          osc2.type = 'sine';
          gain2.gain.value = 0.15;
          gain2.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
          osc2.start();
          osc2.stop(ctx.currentTime + 0.3);
        }, 100);
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
        osc.stop(ctx.currentTime + 0.3);
        break;
      case 'wrong':
        osc.frequency.value = 200;
        osc.type = 'sawtooth';
        gain.gain.value = 0.1;
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
        osc.start();
        osc.stop(ctx.currentTime + 0.3);
        break;
      case 'win':
        const notes = [523, 587, 659, 784, 880];
        notes.forEach((freq, i) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g);
          g.connect(ctx.destination);
          o.frequency.value = freq;
          o.type = 'sine';
          g.gain.value = 0.15;
          g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3 + i * 0.15);
          o.start(ctx.currentTime + i * 0.12);
          o.stop(ctx.currentTime + 0.3 + i * 0.15);
        });
        break;
    }
  } catch(e) { /* silent fail */ }
}

// ====== BACKGROUND MUSIC ======
let bgMusicInterval = null;

function toggleMusic() {
  const btn = document.getElementById('musicBtn');
  if (musicPlaying) {
    stopMusic();
    btn.textContent = 'ğŸ”‡';
  } else {
    startMusic();
    btn.textContent = 'ğŸ”Š';
  }
  musicPlaying = !musicPlaying;
}

function startMusic() {
  const ctx = getAudioCtx();
  // Simple cheerful melody for kids
  const melody = [
    { note: 523, dur: 0.3 }, // C
    { note: 587, dur: 0.3 }, // D
    { note: 659, dur: 0.3 }, // E
    { note: 523, dur: 0.3 }, // C
    { note: 659, dur: 0.3 }, // E
    { note: 698, dur: 0.3 }, // F
    { note: 784, dur: 0.6 }, // G
    { note: 784, dur: 0.3 }, // G
    { note: 698, dur: 0.3 }, // F
    { note: 659, dur: 0.3 }, // E
    { note: 587, dur: 0.3 }, // D
    { note: 523, dur: 0.3 }, // C
    { note: 587, dur: 0.3 }, // D
    { note: 659, dur: 0.3 }, // E
    { note: 523, dur: 0.6 }, // C
  ];
  
  let noteIdx = 0;
  function playNextNote() {
    if (!musicPlaying && noteIdx > 0) return;
    const { note, dur } = melody[noteIdx % melody.length];
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = 'sine';
    osc.frequency.value = note;
    gain.gain.value = 0.06;
    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + dur * 0.9);
    osc.start();
    osc.stop(ctx.currentTime + dur);
    noteIdx++;
  }
  
  playNextNote();
  bgMusicInterval = setInterval(playNextNote, 350);
}

function stopMusic() {
  if (bgMusicInterval) {
    clearInterval(bgMusicInterval);
    bgMusicInterval = null;
  }
}

// ====== PWA SERVICE WORKER ======
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// Start
init();
</script>
</body>
</html>
