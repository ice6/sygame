<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ÊóãËΩ¨Êú®È©¨">
<link rel="manifest" href="manifest.json">
<title>üë¶ Êï∞Â≠óÊéíÂ∫èÊ∏∏Êàè</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Noto+Sans+SC:wght@400;700;900&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

:root {
  --sky: #87CEEB;
  --grass: #4CAF50;
  --road: #333;
  --sun: #FFD700;
  --pink: #FF6B9D;
  --orange: #FF9800;
  --purple: #9C27B0;
  --blue: #2196F3;
  --green: #4CAF50;
}

body {
  font-family: 'Fredoka', 'Noto Sans SC', sans-serif;
  overflow: hidden;
  height: 100vh;
  height: 100dvh;
  width: 100vw;
  background: var(--sky);
  touch-action: manipulation;
}

/* ====== SCENE BACKGROUND ====== */
.scene {
  position: fixed;
  inset: 0;
  overflow: hidden;
  z-index: 0;
}

/* Sky gradient */
.sky {
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, #4FC3F7 0%, #81D4FA 30%, #B3E5FC 60%, #E1F5FE 100%);
}

/* Clouds */
.cloud {
  position: absolute;
  background: white;
  border-radius: 50px;
  opacity: 0.9;
  animation: float-cloud linear infinite;
}
.cloud::before, .cloud::after {
  content: '';
  position: absolute;
  background: white;
  border-radius: 50%;
}
.cloud-1 { width: 120px; height: 40px; top: 8%; left: -150px; animation-duration: 25s; }
.cloud-1::before { width: 50px; height: 50px; top: -25px; left: 20px; }
.cloud-1::after { width: 70px; height: 60px; top: -30px; left: 50px; }
.cloud-2 { width: 90px; height: 30px; top: 15%; left: -120px; animation-duration: 35s; animation-delay: 5s; }
.cloud-2::before { width: 40px; height: 40px; top: -20px; left: 15px; }
.cloud-2::after { width: 55px; height: 45px; top: -22px; left: 40px; }
.cloud-3 { width: 140px; height: 45px; top: 5%; left: -170px; animation-duration: 30s; animation-delay: 12s; }
.cloud-3::before { width: 60px; height: 55px; top: -28px; left: 25px; }
.cloud-3::after { width: 80px; height: 65px; top: -32px; left: 60px; }

@keyframes float-cloud {
  from { transform: translateX(0); }
  to { transform: translateX(calc(100vw + 200px)); }
}

/* Sun */
.sun {
  position: absolute;
  width: 80px; height: 80px;
  background: radial-gradient(circle, #FFF176, #FFD54F, #FFB300);
  border-radius: 50%;
  top: 5%;
  right: 10%;
  box-shadow: 0 0 40px #FFD54F, 0 0 80px rgba(255,213,79,0.4);
  animation: pulse-sun 3s ease-in-out infinite;
}
@keyframes pulse-sun {
  0%, 100% { transform: scale(1); box-shadow: 0 0 40px #FFD54F, 0 0 80px rgba(255,213,79,0.4); }
  50% { transform: scale(1.05); box-shadow: 0 0 60px #FFD54F, 0 0 100px rgba(255,213,79,0.5); }
}

/* City skyline */
.buildings {
  position: absolute;
  bottom: 28%;
  left: 0; right: 0;
  height: 200px;
  display: flex;
  align-items: flex-end;
  justify-content: space-around;
  padding: 0 20px;
}
.building {
  position: relative;
  border-radius: 8px 8px 0 0;
}
.building-1 { width: 60px; height: 140px; background: linear-gradient(135deg, #EF5350, #E53935); }
.building-2 { width: 80px; height: 180px; background: linear-gradient(135deg, #AB47BC, #8E24AA); }
.building-3 { width: 70px; height: 120px; background: linear-gradient(135deg, #42A5F5, #1E88E5); }
.building-4 { width: 90px; height: 160px; background: linear-gradient(135deg, #66BB6A, #43A047); }
.building-5 { width: 55px; height: 100px; background: linear-gradient(135deg, #FFA726, #FB8C00); }
.building-6 { width: 75px; height: 150px; background: linear-gradient(135deg, #EC407A, #D81B60); }
.building-windows {
  position: absolute;
  inset: 10px 8px;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
}
.window {
  background: rgba(255,255,200,0.7);
  border-radius: 2px;
  animation: twinkle 2s ease-in-out infinite;
}
.window:nth-child(odd) { animation-delay: 0.5s; }
.window:nth-child(3n) { animation-delay: 1s; }
@keyframes twinkle {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; background: rgba(255,255,150,1); }
}

/* Office building */
.office {
  position: absolute;
  bottom: 28%;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1;
}
.office-top {
  background: #37474F;
  color: white;
  padding: 8px 30px;
  border-radius: 8px 8px 0 0;
  text-align: center;
  font-size: 18px;
  font-weight: 700;
  letter-spacing: 3px;
}
.office-body {
  width: 140px;
  height: 100px;
  background: linear-gradient(180deg, #ECEFF1, #CFD8DC);
  border-radius: 0 0 4px 4px;
}

/* Trees */
.trees {
  position: absolute;
  bottom: 22%;
  left: 0; right: 0;
  height: 80px;
}
.tree {
  position: absolute;
  bottom: 0;
}
.tree-trunk {
  width: 8px;
  height: 30px;
  background: #795548;
  margin: 0 auto;
  border-radius: 2px;
}
.tree-top {
  width: 40px;
  height: 40px;
  background: radial-gradient(circle, #66BB6A, #2E7D32);
  border-radius: 50%;
  margin: 0 auto;
  margin-bottom: -5px;
}
.tree:nth-child(1) { left: 5%; }
.tree:nth-child(2) { left: 15%; }
.tree:nth-child(3) { left: 30%; }
.tree:nth-child(4) { left: 55%; }
.tree:nth-child(5) { left: 70%; }
.tree:nth-child(6) { left: 85%; }
.tree:nth-child(7) { left: 92%; }

/* Road */
.road {
  position: absolute;
  bottom: 16%;
  left: 0; right: 0;
  height: 60px;
  background: #424242;
  border-top: 4px solid #9E9E9E;
  border-bottom: 4px solid #9E9E9E;
}
.road-line {
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 4px;
  transform: translateY(-50%);
  background: repeating-linear-gradient(90deg, #FFF 0, #FFF 30px, transparent 30px, transparent 60px);
}

/* Car */
.car {
  position: absolute;
  bottom: 18%;
  width: 70px; height: 35px;
  animation: drive 12s linear infinite;
}
.car-body {
  width: 100%; height: 100%;
  background: #FFD54F;
  border-radius: 10px 20px 5px 5px;
  position: relative;
}
.car-window {
  position: absolute;
  top: 5px; left: 30px;
  width: 25px; height: 15px;
  background: rgba(100,200,255,0.7);
  border-radius: 5px 8px 0 0;
}
.car-wheel {
  position: absolute;
  bottom: -5px;
  width: 14px; height: 14px;
  background: #333;
  border-radius: 50%;
}
.car-wheel-front { right: 8px; }
.car-wheel-rear { left: 8px; }
@keyframes drive {
  from { left: -100px; }
  to { left: calc(100% + 100px); }
}

/* Grass */
.grass {
  position: absolute;
  bottom: 0;
  left: 0; right: 0;
  height: 16%;
  background: linear-gradient(180deg, #66BB6A, #4CAF50, #388E3C);
}

/* ====== GAME UI ====== */
.game-container {
  position: relative;
  z-index: 10;
  width: 100%;
  height: 100vh;
  height: 100dvh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: calc(10px + env(safe-area-inset-top)) 15px calc(10px + env(safe-area-inset-bottom));
  overflow: hidden;
}

/* App-like main area: scrolls, title stays visible */
.game-main {
  width: 100%;
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  gap: 8px;
  padding: 4px 0;
}

.game-col-left,
.game-col-right {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}

@media (orientation: portrait) {
  .game-main {
    justify-content: center;
  }
}

@media (orientation: landscape) {
  .game-main {
    width: min(980px, 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    gap: 10px;
    padding: 6px 0;
  }
  .game-col-left,
  .game-col-right {
    align-items: center;
  }

  /* Push main play area (slots/candidates) down */
  .game-col-right {
    margin-top: auto;
    width: 100%;
  }
  .game-col-left {
    flex: 1;
    min-height: 0;
    justify-content: center;
    width: 100%;
  }
}

/* Title */
.game-title {
  font-size: clamp(28px, 3vw, 44px);
  font-weight: 700;
  color: #fff;
  text-shadow: 2px 2px 0 #E91E63, -1px -1px 0 #E91E63, 1px -1px 0 #E91E63, -1px 1px 0 #E91E63;
  margin-bottom: 5px;
  letter-spacing: 2px;
  animation: bounce-title 2s ease-in-out infinite;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
  width: clamp(320px, 95vw, 650px);
  background: linear-gradient(135deg, rgba(255,107,157,0.85), rgba(233,30,99,0.85));
  padding: 6px 12px;
  border-radius: 18px;
  border: 3px solid #fff;
  box-shadow: 0 4px 15px rgba(233,30,99,0.4), inset 0 2px 4px rgba(255,255,255,0.3);
}
.title-left, .title-right {
  display: flex;
  align-items: center;
  gap: 4px;
}
.title-center {
  display: flex;
  align-items: center;
  gap: 6px;
}
.title-icon {
  width: clamp(26px, 5vw, 40px);
  height: auto;
}
.title-number {
  font-size: clamp(28px, 3vw, 44px);
}
.title-score {
  font-size: clamp(11px, 1.5vw, 14px);
  background: rgba(255,255,255,0.25);
  padding: 2px 6px;
  border-radius: 10px;
  white-space: nowrap;
}
.title-diff {
  font-size: clamp(10px, 1.4vw, 13px);
  background: rgba(255,255,255,0.25);
  padding: 2px 6px;
  border-radius: 10px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
  text-shadow: none;
}
.title-diff.active {
  background: #fff;
  color: #E91E63;
  border-color: #fff;
  text-shadow: none;
}
/* Mode buttons inside title */
.title-mode {
  display: flex;
  align-items: center;
  gap: 3px;
  padding: 3px 8px;
  border-radius: 12px;
  background: rgba(255,255,255,0.25);
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}
.title-mode.active {
  background: #fff;
  border-color: #fff;
}
.title-mode .mc {
  border-radius: 50%;
  background: #fff;
}
.title-mode.active .mc {
  background: #E91E63;
}
.title-mode .mode-label {
  font-size: clamp(10px, 1.4vw, 12px);
  font-weight: 800;
  color: #fff;
  text-shadow: none;
  white-space: nowrap;
  margin-left: 4px;
}
.title-mode.active .mode-label {
  color: #E91E63;
}
.title-mode .mc.b { width: 12px; height: 12px; }
.title-mode .mc.m { width: 9px; height: 9px; }
.title-mode .mc.s { width: 6px; height: 6px; }
@keyframes bounce-title {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-2px); }
}

/* Mode buttons - hidden, using title-mode instead */
.mode-row { display: none; }
.mode-btn { display: none; }
.mode-circle { display: none; }
.score-section { display: none; }

/* Spinner area */
.spinner-section {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 10px;
}

.spinner-box {
  width: 80px;
  height: 90px;
  background: rgba(255,255,255,0.95);
  border: 4px solid #1565C0;
  border-radius: 15px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}
.spinner-track {
  position: absolute;
  width: 100%;
  transition: transform 0.1s linear;
}
.spinner-num {
  width: 100%;
  height: 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: 700;
  color: #1565C0;
}

.spin-btn {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, #FF6B9D, #E91E63);
  color: white;
  font-family: inherit;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(233,30,99,0.4);
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  line-height: 1.2;
}
.spin-btn:hover { transform: scale(1.1); }
.spin-btn:active { transform: scale(0.95); }
.spin-btn.spinning {
  animation: wiggle 0.3s ease-in-out infinite;
  pointer-events: none;
}
.play-icon {
  font-size: 32px;
}
@keyframes wiggle {
  0%, 100% { transform: rotate(0); }
  25% { transform: rotate(-5deg); }
  75% { transform: rotate(5deg); }
}

/* Direction indicator - hidden since mode buttons show direction */
.direction-indicator {
  display: none;
}

/* Carousel horses */
.carousel-section {
  width: 100%;
  max-width: 700px;
  margin-bottom: 8px;
  position: relative;
}
.carousel-bar {
  display: flex;
  justify-content: space-around;
  align-items: flex-end;
  height: 80px;
  position: relative;
}
.horse-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 16%;
}
.horse-pole {
  width: 4px;
  height: 25px;
  background: linear-gradient(180deg, #FFD700, #FFA000, #FFD700);
  border-radius: 2px;
}
.horse {
  font-size: clamp(30px, 5vw, 45px);
  animation: horse-bounce 1.5s ease-in-out infinite;
  cursor: default;
  filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.2));
}
.horse:nth-child(1) .horse { animation-delay: 0s; }
.horse-container:nth-child(2) .horse { animation-delay: 0.25s; }
.horse-container:nth-child(3) .horse { animation-delay: 0.5s; }
.horse-container:nth-child(4) .horse { animation-delay: 0.75s; }
.horse-container:nth-child(5) .horse { animation-delay: 1.0s; }
.horse-container:nth-child(6) .horse { animation-delay: 1.25s; }

@keyframes horse-bounce {
  0%, 100% { transform: translateY(0) rotate(-3deg); }
  50% { transform: translateY(-10px) rotate(3deg); }
}

/* Answer slots */
.slots-section {
  display: flex;
  gap: clamp(6px, 1.5vw, 12px);
  margin-bottom: 8px;
  width: 100%;
  max-width: 700px;
  justify-content: center;
}
.slot {
  width: clamp(55px, 12vw, 85px);
  height: clamp(60px, 13vw, 90px);
  background: rgba(255,255,255,0.95);
  border: 3px solid #1565C0;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(24px, 5vw, 40px);
  font-weight: 700;
  color: #1565C0;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  transition: all 0.3s;
  position: relative;
}
.slot.first-slot {
  background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
  border-color: #0D47A1;
  color: #0D47A1;
}
.slot.filled {
  background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
  border-color: #2E7D32;
  color: #2E7D32;
  animation: pop-in 0.3s ease-out;
}
.slot.wrong {
  background: linear-gradient(135deg, #FFEBEE, #FFCDD2);
  border-color: #C62828;
  color: #C62828;
  animation: shake 0.5s ease-out;
}
.slot.drop-target {
  border-color: #FF6B9D;
  border-style: dashed;
  background: rgba(255,107,157,0.1);
  transform: scale(1.05);
}
@keyframes pop-in {
  0% { transform: scale(0.5); }
  60% { transform: scale(1.15); }
  100% { transform: scale(1); }
}
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20% { transform: translateX(-8px); }
  40% { transform: translateX(8px); }
  60% { transform: translateX(-5px); }
  80% { transform: translateX(5px); }
}

/* Candidate numbers */
.candidates-section {
  display: flex;
  gap: clamp(6px, 1.5vw, 12px);
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 10px;
  min-height: 60px;
}
.candidate {
  width: clamp(45px, 10vw, 65px);
  height: clamp(45px, 10vw, 65px);
  background: linear-gradient(135deg, #FFE082, #FFD54F);
  border: 3px solid #F57F17;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(22px, 4.5vw, 36px);
  font-weight: 700;
  color: #E65100;
  cursor: grab;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  user-select: none;
  -webkit-user-select: none;
  touch-action: none;
}
.candidate:hover { transform: scale(1.1) rotate(-3deg); }
.candidate:active { cursor: grabbing; transform: scale(1.15); }
.candidate.dragging {
  opacity: 0.5;
  transform: scale(0.9);
}
.candidate.used {
  opacity: 0.3;
  pointer-events: none;
  transform: scale(0.8);
}

/* Floating drag preview */
.drag-preview {
  position: fixed;
  width: 60px; height: 60px;
  background: linear-gradient(135deg, #FF8A65, #FF5722);
  border: 3px solid #BF360C;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  font-weight: 700;
  color: white;
  pointer-events: none;
  z-index: 1000;
  transform: translate(-50%, -50%) scale(1.2);
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  display: none;
}

/* Feedback */
.feedback {
  font-size: clamp(16px, 3vw, 24px);
  font-weight: 700;
  color: #fff;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  min-height: 35px;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Score */
.score-section {
  display: flex;
  gap: 20px;
  margin-bottom: 5px;
}
.score-item {
  padding: 4px 15px;
  background: rgba(255,255,255,0.3);
  border-radius: 20px;
  color: #fff;
  font-weight: 600;
  font-size: clamp(12px, 2vw, 16px);
  backdrop-filter: blur(5px);
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

/* Celebration overlay */
.celebration {
  position: fixed;
  inset: 0;
  z-index: 100;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.3);
}
.celebration.show { display: flex; }
.celebration-content {
  text-align: center;
  animation: celebrate-bounce 0.6s ease-out;
}
@keyframes celebrate-bounce {
  0% { transform: scale(0); }
  60% { transform: scale(1.2); }
  100% { transform: scale(1); }
}
.celebration-emoji {
  font-size: 80px;
  animation: spin-celebrate 1s ease-in-out infinite;
}
@keyframes spin-celebrate {
  0%, 100% { transform: rotate(0) scale(1); }
  50% { transform: rotate(10deg) scale(1.1); }
}
.celebration-text {
  font-size: 36px;
  font-weight: 700;
  color: #fff;
  text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
  margin-top: 10px;
}
.celebration-sub {
  font-size: 18px;
  color: #FFE082;
  margin-top: 8px;
}
.next-btn {
  margin-top: 20px;
  padding: 12px 40px;
  background: linear-gradient(135deg, #FF6B9D, #E91E63);
  border: none;
  border-radius: 30px;
  color: white;
  font-family: inherit;
  font-size: 20px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 6px 20px rgba(233,30,99,0.4);
  transition: transform 0.2s;
}
.next-btn:hover { transform: scale(1.1); }

/* Confetti */
.confetti-piece {
  position: fixed;
  width: 10px;
  height: 10px;
  z-index: 101;
  animation: confetti-fall 3s ease-out forwards;
}
@keyframes confetti-fall {
  0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* Music control */
.music-btn {
  position: fixed;
  bottom: 15px;
  right: 15px;
  width: 45px; height: 45px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,0.8);
  font-size: 22px;
  cursor: pointer;
  z-index: 50;
  box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  transition: transform 0.2s;
}
.music-btn:hover { transform: scale(1.1); }

/* Responsive adjustments for iPad */
@media (min-width: 768px) {
  .game-container { padding: 15px 30px; }
  .spinner-box { width: 100px; height: 110px; }
  .spinner-num { height: 110px; font-size: 60px; }
  .spin-btn { width: 85px; height: 85px; font-size: 16px; }
}

/* Tablet landscape (e.g., iPad Air Ê®™Â±è) */
@media (orientation: landscape) and (min-width: 1024px) {
  .game-title {
    width: min(1180px, 96vw);
  }
  .game-main {
    width: min(1180px, 96vw);
    gap: 14px;
  }

  .spinner-box { width: 110px; height: 120px; }
  .spinner-num { height: 120px; font-size: 66px; }
  .spin-btn { width: 92px; height: 92px; }
  .play-icon { font-size: 38px; }

  .carousel-bar { height: 100px; }
  .horse { font-size: clamp(34px, 4.5vw, 54px); }
  .horse-pole { height: 30px; }

  .slots-section { max-width: 720px; }
  .slot {
    width: clamp(60px, 5.5vw, 95px);
    height: clamp(68px, 6vw, 105px);
    font-size: clamp(28px, 3.2vw, 44px);
  }
  .candidates-section { max-width: 720px; }
  .candidate {
    width: clamp(52px, 4.8vw, 78px);
    height: clamp(52px, 4.8vw, 78px);
    font-size: clamp(24px, 3vw, 40px);
  }
  .feedback { font-size: clamp(16px, 2.2vw, 22px); }
}

@media (max-height: 700px) {
  .carousel-bar { height: 60px; }
  .horse { font-size: 28px !important; }
  .horse-pole { height: 15px; }
  .slot { height: 55px !important; }
  .candidate { width: 42px !important; height: 42px !important; font-size: 20px !important; }
}

/* Small phones (e.g., iPhone SE) */
@media (max-width: 375px) and (max-height: 650px) {
  .game-container {
    padding: calc(6px + env(safe-area-inset-top)) 10px calc(6px + env(safe-area-inset-bottom));
  }
  .game-main {
    justify-content: flex-start;
    gap: 6px;
    padding: 2px 0;
  }

  .game-title {
    padding: 5px 10px;
    border-width: 3px;
    border-radius: 16px;
  }

  .spinner-section { margin-bottom: 6px; gap: 10px; }
  .spinner-box { width: 70px; height: 78px; border-width: 3px; }
  .spinner-num { height: 78px; font-size: 46px; }
  .spin-btn { width: 62px; height: 62px; }
  .play-icon { font-size: 30px; }

  .carousel-bar { height: 44px; }
  .horse { font-size: 24px !important; }
  .horse-pole { height: 12px; }

  .slots-section { margin-bottom: 6px; gap: 6px; }
  .slot {
    width: clamp(46px, 12vw, 70px);
    height: 52px !important;
    font-size: clamp(20px, 5vw, 32px);
    border-width: 2px;
  }

  .candidates-section { margin-bottom: 6px; min-height: 44px; gap: 6px; }
  .candidate { width: 40px !important; height: 40px !important; font-size: 18px !important; border-width: 2px; }
  .feedback { min-height: 28px; }
}

/* Short landscape (height ~375px): keep ‚ñ∂ fully visible by shrinking bottom area */
@media (orientation: landscape) and (max-height: 420px) {
  .game-container {
    padding: calc(6px + env(safe-area-inset-top)) 12px calc(6px + env(safe-area-inset-bottom));
  }
  .game-main {
    gap: 8px;
  }

  /* Ensure top area keeps enough space for spinner + ‚ñ∂ */
  .game-col-left { flex: 1 0 auto; }

  /* Cap bottom stack height (carousel+slots+candidates+feedback) */
  .game-col-right {
    margin-top: auto;
    max-height: 58%;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: calc(64px + env(safe-area-inset-bottom));
  }

  .spinner-box { width: 74px; height: 82px; }
  .spinner-num { height: 82px; font-size: 48px; }
  .spin-btn { width: 64px; height: 64px; }
  .play-icon { font-size: 30px; }

  .carousel-bar { height: 46px; }
  .horse { font-size: 24px !important; }
  .horse-pole { height: 12px; }

  /* Overlay candidates onto horses to save height */
  .carousel-section { order: 1; margin-bottom: 0; }
  .candidates-section {
    order: 2;
    margin-top: -46px;
    z-index: 5;
    padding: 4px 0;
  }
  .slots-section { order: 3; }
  .feedback { order: 4; }

  .slots-section { gap: 6px; margin-bottom: 6px; }
  .slot {
    height: 48px !important;
    border-width: 2px;
  }

  .candidates-section { gap: 6px; margin-bottom: 6px; min-height: 40px; }
  .candidate { width: 38px !important; height: 38px !important; font-size: 18px !important; border-width: 2px; }
  .feedback {
    min-height: 26px;
    padding: 4px 0;
  }
}
</style>
</head>
<body>

<!-- BACKGROUND SCENE -->
<div class="scene">
  <div class="sky"></div>
  <div class="sun"></div>
  <div class="cloud cloud-1"></div>
  <div class="cloud cloud-2"></div>
  <div class="cloud cloud-3"></div>
  <div class="buildings">
    <div class="building building-1"><div class="building-windows"><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div></div></div>
    <div class="building building-5"><div class="building-windows"><div class="window"></div><div class="window"></div><div class="window"></div></div></div>
    <div class="building building-3"><div class="building-windows"><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div></div></div>
    <div class="building building-4"><div class="building-windows"><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div></div></div>
    <div class="building building-6"><div class="building-windows"><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div></div></div>
    <div class="building building-2"><div class="building-windows"><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div><div class="window"></div></div></div>
  </div>
  <div class="trees">
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
    <div class="tree"><div class="tree-top"></div><div class="tree-trunk"></div></div>
  </div>
  <div class="road"><div class="road-line"></div></div>
  <div class="car">
    <div class="car-body">
      <div class="car-window"></div>
      <div class="car-wheel car-wheel-front"></div>
      <div class="car-wheel car-wheel-rear"></div>
    </div>
  </div>
  <div class="grass"></div>
</div>

<!-- GAME UI -->
<div class="game-container">
  <div class="game-title">
    <div class="title-left">
      <img src="happy-boy.png" alt="happy-boy" class="title-icon">
      <span class="title-number">6</span>
    </div>
    <div class="title-center">
      <span class="title-mode active" data-mode="desc" onclick="setMode('desc')" title="‰ªéÂ§ßÂà∞Â∞è">
        <span class="mc b"></span><span class="mc m"></span><span class="mc s"></span>
        <span class="mode-label">Áî±Â§ßÂà∞Â∞è</span>
      </span>
      <span class="title-mode" data-mode="asc" onclick="setMode('asc')" title="‰ªéÂ∞èÂà∞Â§ß">
        <span class="mc s"></span><span class="mc m"></span><span class="mc b"></span>
        <span class="mode-label">Áî±Â∞èÂà∞Â§ß</span>
      </span>
      <span class="title-score">‚≠ê<span id="score">0</span></span>
      <span class="title-score">üéØ<span id="streak">0</span></span>
    </div>
    <div class="title-right">
      <span class="title-diff active" data-diff="easy" onclick="setDifficulty('easy')">ÁÆÄÂçï</span>
      <span class="title-diff" data-diff="hard" onclick="setDifficulty('hard')">Âõ∞Èöæ</span>
    </div>
  </div>

  <div class="game-main">
    <div class="game-col-left">
      <div class="spinner-section">
        <div class="spinner-box">
          <div class="spinner-track" id="spinnerTrack"></div>
        </div>
        <button class="spin-btn" id="spinBtn" onclick="startSpin()">
          <span class="play-icon">‚ñ∂</span>
        </button>
      </div>

      <div class="direction-indicator"></div>
    </div>

    <div class="game-col-right">
      <div class="carousel-section">
        <div class="carousel-bar" id="carouselBar"></div>
      </div>
      <div class="slots-section" id="slotsSection"></div>
      <div class="candidates-section" id="candidatesSection"></div>
      <div class="feedback" id="feedback"></div>
    </div>
  </div>
</div>

<!-- Celebration overlay -->
<div class="celebration" id="celebration">
  <div class="celebration-content">
    <div class="celebration-emoji">üéâ</div>
    <div class="celebration-text">Â§™Ê£í‰∫ÜÔºÅ</div>
    <div class="celebration-sub" id="celebrationSub">ÂÖ®ÈÉ®Á≠îÂØπ‰∫ÜÔºÅ</div>
    <button class="next-btn" onclick="nextRound()">‰∏ã‰∏ÄËΩÆ ‚ñ∂</button>
  </div>
</div>

<!-- Drag preview -->
<div class="drag-preview" id="dragPreview"></div>

<!-- Music toggle -->
<button class="music-btn" id="musicBtn" onclick="toggleMusic()">üîá</button>

<script>
// ====== GAME STATE ======
let mode = 'desc'; // desc = Â§ßÂà∞Â∞è, asc = Â∞èÂà∞Â§ß
let difficulty = 'easy'; // easy = only answer numbers, hard = 1-9
let firstNumber = null;
let firstPosition = 0; // Ëµ∑ÂßãÊï∞Â≠óÁöÑ‰ΩçÁΩÆ (0-5)
let isSpinning = false;
let filledSlots = [null, null, null, null, null, null]; // 6‰∏™ÊßΩ‰Ωç
let score = 0;
let streak = 0;
let currentSlotIndex = 0;
let musicPlaying = false;
let audioCtx = null;

// ====== INITIALIZATION ======
function init() {
  buildCarousel();
  buildSpinner();
  updateDirection();
  buildSlots();
  updateFeedback('ÁÇπÂáª üé∞ ÊåâÈíÆÂºÄÂßãÊ∏∏ÊàèÔºÅ', 'üéÆ');
}

// ====== MODE & DIFFICULTY ======
function setMode(m) {
  mode = m;
  document.querySelectorAll('[data-mode]').forEach(b => b.classList.toggle('active', b.dataset.mode === m));
  updateDirection();
  resetRound();
}

function setDifficulty(d) {
  difficulty = d;
  document.querySelectorAll('[data-diff]').forEach(b => b.classList.toggle('active', b.dataset.diff === d));
  if (firstNumber !== null) buildCandidates();
}

function updateDirection() {
  // Direction indicator hidden - mode shown in title-mode buttons
}

// ====== CAROUSEL HORSES ======
function buildCarousel() {
  const bar = document.getElementById('carouselBar');
  const horses = ['üê¥', 'ü¶Ñ', 'üêé', 'üê¥', 'ü¶Ñ', 'üêé'];
  const colors = ['#FF6B9D', '#9C27B0', '#FF9800', '#4CAF50', '#2196F3', '#E91E63'];
  bar.innerHTML = horses.map((h, i) => `
    <div class="horse-container">
      <div class="horse" style="animation-delay: ${i * 0.25}s; color: ${colors[i]}">${h}</div>
      <div class="horse-pole"></div>
    </div>
  `).join('');
}

// ====== SPINNER ======
function buildSpinner() {
  const track = document.getElementById('spinnerTrack');
  // Numbers 1-10 for the spinner
  const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
  track.innerHTML = nums.concat(nums).concat(nums).map(n => 
    `<div class="spinner-num">${n}</div>`
  ).join('');
}

function startSpin() {
  if (isSpinning) return;
  isSpinning = true;
  
  const btn = document.getElementById('spinBtn');
  btn.classList.add('spinning');
  
  // Reset previous round
  filledSlots = [null, null, null, null, null, null];
  currentSlotIndex = 0;
  
  playSound('spin');
  updateFeedback('ËΩ¨Âä®‰∏≠...', 'üé∞');
  
  // ÈöèÊú∫ÈÄâÊã©Ëµ∑Âßã‰ΩçÁΩÆ (0-5)
  firstPosition = Math.floor(Math.random() * 6);
  
  // Ê†πÊçÆ‰ΩçÁΩÆÂíåÊ®°ÂºèËÆ°ÁÆóÂêàÈÄÇÁöÑÊï∞Â≠óËåÉÂõ¥
  // ‰ªéÂ§ßÂà∞Â∞è: Â∑¶ËæπÈúÄË¶ÅÊõ¥Â§ßÁöÑÊï∞ÔºåÂè≥ËæπÈúÄË¶ÅÊõ¥Â∞èÁöÑÊï∞
  // ‰ªéÂ∞èÂà∞Â§ß: Â∑¶ËæπÈúÄË¶ÅÊõ¥Â∞èÁöÑÊï∞ÔºåÂè≥ËæπÈúÄË¶ÅÊõ¥Â§ßÁöÑÊï∞
  const leftSlots = firstPosition; // Â∑¶ËæπÊúâÂ§öÂ∞ë‰∏™Á©∫‰Ωç
  const rightSlots = 5 - firstPosition; // Âè≥ËæπÊúâÂ§öÂ∞ë‰∏™Á©∫‰Ωç
  
  let minNum, maxNum;
  if (mode === 'desc') {
    // ‰ªéÂ§ßÂà∞Â∞è: Â∑¶ËæπÊîæÊõ¥Â§ßÁöÑÊï∞ÔºåÂè≥ËæπÊîæÊõ¥Â∞èÁöÑÊï∞
    // ÊúÄÂ∞èÂÄº: ÈúÄË¶ÅÂè≥ËæπÊúârightSlots‰∏™Êõ¥Â∞èÁöÑÊï∞ (rightSlots + 1)
    // ÊúÄÂ§ßÂÄº: ÈúÄË¶ÅÂ∑¶ËæπÊúâleftSlots‰∏™Êõ¥Â§ßÁöÑÊï∞ (10 - leftSlots)
    minNum = rightSlots + 1;
    maxNum = 10 - leftSlots;
  } else {
    // ‰ªéÂ∞èÂà∞Â§ß: Â∑¶ËæπÊîæÊõ¥Â∞èÁöÑÊï∞ÔºåÂè≥ËæπÊîæÊõ¥Â§ßÁöÑÊï∞
    // ÊúÄÂ∞èÂÄº: ÈúÄË¶ÅÂ∑¶ËæπÊúâleftSlots‰∏™Êõ¥Â∞èÁöÑÊï∞ (leftSlots + 1)
    // ÊúÄÂ§ßÂÄº: ÈúÄË¶ÅÂè≥ËæπÊúârightSlots‰∏™Êõ¥Â§ßÁöÑÊï∞ (10 - rightSlots)
    minNum = leftSlots + 1;
    maxNum = 10 - rightSlots;
  }
  
  // ÁîüÊàêÂèØÈÄâÊï∞Â≠óÂàóË°®
  const validNums = [];
  for (let i = minNum; i <= maxNum; i++) {
    validNums.push(i);
  }
  
  const track = document.getElementById('spinnerTrack');
  const nums = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
  const targetNum = validNums[Math.floor(Math.random() * validNums.length)];
  const targetIdx = nums.indexOf(targetNum);
  const itemHeight = track.querySelector('.spinner-num').offsetHeight || 90;
  
  let currentOffset = 0;
  const totalItems = nums.length * 2 + targetIdx; // spin through 2 full cycles + land on target
  const totalDistance = totalItems * itemHeight;
  const duration = 2000;
  const startTime = performance.now();
  
  function animateSpin(now) {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed / duration, 1);
    // Ease out cubic
    const eased = 1 - Math.pow(1 - progress, 3);
    currentOffset = eased * totalDistance;
    track.style.transform = `translateY(-${currentOffset}px)`;
    
    if (progress < 1) {
      requestAnimationFrame(animateSpin);
    } else {
      // Land on target
      firstNumber = targetNum;
      isSpinning = false;
      btn.classList.remove('spinning');
      
      // Reset spinner position cleanly
      track.style.transform = `translateY(-${targetIdx * itemHeight}px)`;
      
      playSound('ding');
      updateFeedback(`Ëµ∑ÂßãÊï∞Â≠óÊòØ ${targetNum}ÔºÅËØ∑${mode === 'desc' ? '‰ªéÂ§ßÂà∞Â∞è' : '‰ªéÂ∞èÂà∞Â§ß'}ÊéíÂàó`, '‚ú®');
      
      buildSlots();
      buildCandidates();
    }
  }
  requestAnimationFrame(animateSpin);
}

// ====== SLOTS ======
function buildSlots() {
  const section = document.getElementById('slotsSection');
  section.innerHTML = '';
  
  for (let i = 0; i < 6; i++) {
    const slot = document.createElement('div');
    slot.className = 'slot' + (i === firstPosition && firstNumber !== null ? ' first-slot' : '');
    slot.dataset.index = i;
    
    if (i === firstPosition && firstNumber !== null) {
      slot.textContent = firstNumber;
      slot.classList.add('filled');
      filledSlots[i] = firstNumber;
    }
    
    // Drop target events for empty slots
    if (i !== firstPosition || firstNumber === null) {
      slot.addEventListener('dragover', handleDragOver);
      slot.addEventListener('drop', handleDrop);
      slot.addEventListener('dragenter', handleDragEnter);
      slot.addEventListener('dragleave', handleDragLeave);
    }
    
    section.appendChild(slot);
  }
}

// ====== CANDIDATES ======
function buildCandidates() {
  if (firstNumber === null) return;
  
  const section = document.getElementById('candidatesSection');
  section.innerHTML = '';
  
  // ËÆ°ÁÆóÊâÄÊúâÈúÄË¶ÅÂ°´ÂÖ•ÁöÑÊ≠£Á°ÆÊï∞Â≠ó
  let correctAnswers = [];
  
  if (mode === 'desc') {
    // ‰ªéÂ§ßÂà∞Â∞èÔºöÂ∑¶ËæπÊòØÊõ¥Â§ßÁöÑÊï∞ÔºåÂè≥ËæπÊòØÊõ¥Â∞èÁöÑÊï∞
    // Â∑¶ËæπÁöÑÊï∞Â≠óÔºà‰ΩçÁΩÆ0Âà∞firstPosition-1Ôºâ
    for (let i = 0; i < firstPosition; i++) {
      correctAnswers.push(firstNumber + (firstPosition - i));
    }
    // Âè≥ËæπÁöÑÊï∞Â≠óÔºà‰ΩçÁΩÆfirstPosition+1Âà∞5Ôºâ
    for (let i = firstPosition + 1; i < 6; i++) {
      correctAnswers.push(firstNumber - (i - firstPosition));
    }
  } else {
    // ‰ªéÂ∞èÂà∞Â§ßÔºöÂ∑¶ËæπÊòØÊõ¥Â∞èÁöÑÊï∞ÔºåÂè≥ËæπÊòØÊõ¥Â§ßÁöÑÊï∞
    // Â∑¶ËæπÁöÑÊï∞Â≠óÔºà‰ΩçÁΩÆ0Âà∞firstPosition-1Ôºâ
    for (let i = 0; i < firstPosition; i++) {
      correctAnswers.push(firstNumber - (firstPosition - i));
    }
    // Âè≥ËæπÁöÑÊï∞Â≠óÔºà‰ΩçÁΩÆfirstPosition+1Âà∞5Ôºâ
    for (let i = firstPosition + 1; i < 6; i++) {
      correctAnswers.push(firstNumber + (i - firstPosition));
    }
  }
  
  let candidates;
  if (difficulty === 'easy') {
    // Only show the 5 correct answers, shuffled
    candidates = [...correctAnswers];
  } else {
    // Show 1-10 range
    candidates = [];
    for (let i = 1; i <= 10; i++) {
      if (i !== firstNumber) candidates.push(i);
    }
  }
  
  // Shuffle
  for (let i = candidates.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
  }
  
  candidates.forEach(num => {
    const el = document.createElement('div');
    el.className = 'candidate';
    el.textContent = num;
    el.dataset.value = num;
    el.draggable = true;
    
    // Desktop drag
    el.addEventListener('dragstart', handleDragStart);
    el.addEventListener('dragend', handleDragEnd);
    
    // Touch drag
    el.addEventListener('touchstart', handleTouchStart, { passive: false });
    el.addEventListener('touchmove', handleTouchMove, { passive: false });
    el.addEventListener('touchend', handleTouchEnd, { passive: false });
    
    // Click to auto-fill next slot
    el.addEventListener('click', () => handleCandidateClick(el));
    
    section.appendChild(el);
  });
}

// ====== DRAG & DROP (Desktop) ======
let draggedValue = null;
let draggedEl = null;

function handleDragStart(e) {
  draggedValue = parseInt(e.target.dataset.value);
  draggedEl = e.target;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
  e.target.classList.remove('dragging');
  document.querySelectorAll('.slot').forEach(s => s.classList.remove('drop-target'));
}

function handleDragOver(e) {
  e.preventDefault();
}

function handleDragEnter(e) {
  const slot = e.target.closest('.slot');
  if (slot && !slot.classList.contains('filled')) {
    slot.classList.add('drop-target');
  }
}

function handleDragLeave(e) {
  const slot = e.target.closest('.slot');
  if (slot) slot.classList.remove('drop-target');
}

function handleDrop(e) {
  e.preventDefault();
  const slot = e.target.closest('.slot');
  if (!slot) return;
  slot.classList.remove('drop-target');
  
  const slotIdx = parseInt(slot.dataset.index);
  // ÊãñÂä®ÂèØ‰ª•ÊîæÂà∞‰ªªÊÑèÁ©∫ÊßΩ‰ΩçÔºå‰∏çÈôêÈ°∫Â∫è
  if (filledSlots[slotIdx] === null && draggedValue !== null) {
    placeNumberAtSlot(draggedValue, draggedEl, slotIdx);
  }
}

// ====== TOUCH DRAG (Mobile/iPad) ======
let touchDragEl = null;
let touchDragValue = null;
let touchStartX = 0;
let touchStartY = 0;

function handleTouchStart(e) {
  e.preventDefault();
  const el = e.target.closest('.candidate');
  if (!el || el.classList.contains('used')) return;
  
  touchDragEl = el;
  touchDragValue = parseInt(el.dataset.value);
  el.classList.add('dragging');
  
  const touch = e.touches[0];
  touchStartX = touch.clientX;
  touchStartY = touch.clientY;
  
  const preview = document.getElementById('dragPreview');
  preview.textContent = touchDragValue;
  preview.style.display = 'flex';
  preview.style.left = touch.clientX + 'px';
  preview.style.top = touch.clientY + 'px';
}

function handleTouchMove(e) {
  e.preventDefault();
  if (!touchDragEl) return;
  
  const touch = e.touches[0];
  const preview = document.getElementById('dragPreview');
  preview.style.left = touch.clientX + 'px';
  preview.style.top = touch.clientY + 'px';
  
  // Highlight slot under finger - ÊãñÂä®ÂèØ‰ª•È´ò‰∫Æ‰ªªÊÑèÁ©∫ÊßΩ‰Ωç
  const slotEl = document.elementFromPoint(touch.clientX, touch.clientY);
  document.querySelectorAll('.slot').forEach(s => s.classList.remove('drop-target'));
  if (slotEl) {
    const slot = slotEl.closest('.slot');
    if (slot && !slot.classList.contains('filled')) {
      slot.classList.add('drop-target');
    }
  }
}

function handleTouchEnd(e) {
  e.preventDefault();
  if (!touchDragEl) return;
  
  const preview = document.getElementById('dragPreview');
  
  // ÂÖàËé∑ÂèñËß¶Êë∏‰ΩçÁΩÆÂíåÁõÆÊ†áÂÖÉÁ¥†ÔºåÂÜçÈöêËóèÈ¢ÑËßà
  const touch = e.changedTouches[0];
  const dx = Math.abs(touch.clientX - touchStartX);
  const dy = Math.abs(touch.clientY - touchStartY);
  
  // ‰∏¥Êó∂ÈöêËóèÈ¢ÑËßà‰ª•Ëé∑Âèñ‰∏ãÊñπÂÖÉÁ¥†
  preview.style.visibility = 'hidden';
  const targetEl = document.elementFromPoint(touch.clientX, touch.clientY);
  preview.style.visibility = '';
  preview.style.display = 'none';
  
  touchDragEl.classList.remove('dragging');
  document.querySelectorAll('.slot').forEach(s => s.classList.remove('drop-target'));
  
  if (dx < 10 && dy < 10) {
    // It's a tap - ÁÇπÂáªÊåâÈ°∫Â∫èÂ°´Á©∫
    handleCandidateClick(touchDragEl);
  } else {
    // ÊãñÂä®ÂèØ‰ª•ÊîæÂà∞‰ªªÊÑèÁ©∫ÊßΩ‰Ωç
    if (targetEl) {
      const slot = targetEl.closest('.slot');
      if (slot) {
        const slotIdx = parseInt(slot.dataset.index);
        if (filledSlots[slotIdx] === null) {
          placeNumberAtSlot(touchDragValue, touchDragEl, slotIdx);
        }
      }
    }
  }
  
  touchDragEl = null;
  touchDragValue = null;
}

// ====== CLICK TO PLACE ======
function handleCandidateClick(el) {
  if (el.classList.contains('used')) return;
  const value = parseInt(el.dataset.value);
  placeNumber(value, el);
}

// ====== PLACE NUMBER LOGIC ======
// ÁÇπÂáªÁ≠îÈ¢òÔºöÊåâÈ°∫Â∫èÂ°´Á©∫
function placeNumber(value, candidateEl) {
  if (firstNumber === null) return;
  
  // Find next empty slot (ÊåâÈ°∫Â∫è)
  let nextSlot = -1;
  for (let i = 0; i < 6; i++) {
    if (filledSlots[i] === null) { nextSlot = i; break; }
  }
  if (nextSlot === -1) return;
  
  placeNumberAtSlot(value, candidateEl, nextSlot);
}

// ÊãñÂä®Á≠îÈ¢òÔºöÊîæÂà∞ÊåáÂÆöÊßΩ‰Ωç
function placeNumberAtSlot(value, candidateEl, targetSlot) {
  if (firstNumber === null) return;
  if (targetSlot < 0 || targetSlot >= 6) return;
  if (filledSlots[targetSlot] !== null) return;
  
  // Calculate expected value based on position relative to firstPosition
  let expectedValue;
  if (mode === 'desc') {
    // ‰ªéÂ§ßÂà∞Â∞èÔºöÂ∑¶ËæπÊõ¥Â§ßÔºåÂè≥ËæπÊõ¥Â∞è
    if (targetSlot < firstPosition) {
      expectedValue = firstNumber + (firstPosition - targetSlot);
    } else {
      expectedValue = firstNumber - (targetSlot - firstPosition);
    }
  } else {
    // ‰ªéÂ∞èÂà∞Â§ßÔºöÂ∑¶ËæπÊõ¥Â∞èÔºåÂè≥ËæπÊõ¥Â§ß
    if (targetSlot < firstPosition) {
      expectedValue = firstNumber - (firstPosition - targetSlot);
    } else {
      expectedValue = firstNumber + (targetSlot - firstPosition);
    }
  }
  
  const slotEl = document.querySelectorAll('.slot')[targetSlot];
  
  if (value === expectedValue) {
    // Correct!
    filledSlots[targetSlot] = value;
    slotEl.textContent = value;
    slotEl.classList.add('filled');
    candidateEl.classList.add('used');
    playSound('correct');
    
    // Check if all filled
    if (filledSlots.every(v => v !== null)) {
      // Win!
      score += 10 + streak * 2;
      streak++;
      document.getElementById('score').textContent = score;
      document.getElementById('streak').textContent = streak;
      
      updateFeedback('üéâ ÂÖ®ÈÉ®Ê≠£Á°ÆÔºÅÂ§™Ê£í‰∫ÜÔºÅ', 'üåü');
      playSound('win');
      
      setTimeout(() => showCelebration(), 500);
    } else {
      updateFeedback('‚úÖ Ê≠£Á°ÆÔºÅÁªßÁª≠Âä†Ê≤πÔºÅ', 'üëç');
    }
  } else {
    // Wrong!
    slotEl.classList.add('wrong');
    setTimeout(() => slotEl.classList.remove('wrong'), 600);
    streak = 0;
    document.getElementById('streak').textContent = streak;
    playSound('wrong');
    updateFeedback(`‚ùå ‰∏çÂØπÂì¶ÔºåÂÜçÊÉ≥ÊÉ≥ÔºÅ`, 'ü§î');
  }
}

// ====== CELEBRATION ======
function showCelebration() {
  const cel = document.getElementById('celebration');
  cel.classList.add('show');
  document.getElementById('celebrationSub').textContent = `ÂæóÂàÜ: ${score} ‚≠ê ËøûÂØπ: ${streak} üéØ`;
  
  // Confetti
  for (let i = 0; i < 30; i++) {
    const piece = document.createElement('div');
    piece.className = 'confetti-piece';
    piece.style.left = Math.random() * 100 + 'vw';
    piece.style.top = '-20px';
    piece.style.animationDelay = Math.random() * 1 + 's';
    piece.style.animationDuration = (2 + Math.random() * 2) + 's';
    piece.style.background = ['#FF6B9D','#FFD54F','#4CAF50','#2196F3','#9C27B0','#FF9800'][Math.floor(Math.random()*6)];
    piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
    piece.style.width = (6 + Math.random() * 8) + 'px';
    piece.style.height = (6 + Math.random() * 8) + 'px';
    document.body.appendChild(piece);
    setTimeout(() => piece.remove(), 4000);
  }
}

function nextRound() {
  document.getElementById('celebration').classList.remove('show');
  resetRound();
}

function resetRound() {
  firstNumber = null;
  firstPosition = 0;
  filledSlots = [null, null, null, null, null, null];
  currentSlotIndex = 0;
  buildSlots();
  document.getElementById('candidatesSection').innerHTML = '';
  updateFeedback('ÁÇπÂáª üé∞ ÊåâÈíÆÂºÄÂßãÊñ∞‰∏ÄËΩÆÔºÅ', 'üéÆ');
  
  // Reset spinner
  const track = document.getElementById('spinnerTrack');
  track.style.transform = 'translateY(0)';
}

// ====== FEEDBACK ======
function updateFeedback(text, emoji) {
  const fb = document.getElementById('feedback');
  fb.innerHTML = `<span>${emoji || ''}</span> ${text}`;
}

// ====== SOUND EFFECTS (Web Audio API) ======
function getAudioCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  return audioCtx;
}

function playSound(type) {
  try {
    const ctx = getAudioCtx();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    
    switch(type) {
      case 'spin':
        osc.frequency.value = 300;
        osc.frequency.linearRampToValueAtTime(800, ctx.currentTime + 0.3);
        gain.gain.value = 0.15;
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.5);
        osc.start();
        osc.stop(ctx.currentTime + 0.5);
        break;
      case 'ding':
        osc.frequency.value = 880;
        osc.type = 'sine';
        gain.gain.value = 0.2;
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.4);
        osc.start();
        osc.stop(ctx.currentTime + 0.4);
        break;
      case 'correct':
        osc.frequency.value = 523;
        osc.type = 'sine';
        gain.gain.value = 0.15;
        osc.start();
        setTimeout(() => {
          const osc2 = ctx.createOscillator();
          const gain2 = ctx.createGain();
          osc2.connect(gain2);
          gain2.connect(ctx.destination);
          osc2.frequency.value = 659;
          osc2.type = 'sine';
          gain2.gain.value = 0.15;
          gain2.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
          osc2.start();
          osc2.stop(ctx.currentTime + 0.3);
        }, 100);
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
        osc.stop(ctx.currentTime + 0.3);
        break;
      case 'wrong':
        osc.frequency.value = 200;
        osc.type = 'sawtooth';
        gain.gain.value = 0.1;
        gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
        osc.start();
        osc.stop(ctx.currentTime + 0.3);
        break;
      case 'win':
        const notes = [523, 587, 659, 784, 880];
        notes.forEach((freq, i) => {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.connect(g);
          g.connect(ctx.destination);
          o.frequency.value = freq;
          o.type = 'sine';
          g.gain.value = 0.15;
          g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3 + i * 0.15);
          o.start(ctx.currentTime + i * 0.12);
          o.stop(ctx.currentTime + 0.3 + i * 0.15);
        });
        break;
    }
  } catch(e) { /* silent fail */ }
}

// ====== BACKGROUND MUSIC ======
let bgMusicInterval = null;

function toggleMusic() {
  const btn = document.getElementById('musicBtn');
  if (musicPlaying) {
    stopMusic();
    btn.textContent = 'üîá';
  } else {
    startMusic();
    btn.textContent = 'üîä';
  }
  musicPlaying = !musicPlaying;
}

function startMusic() {
  const ctx = getAudioCtx();
  // Simple cheerful melody for kids
  const melody = [
    { note: 523, dur: 0.3 }, // C
    { note: 587, dur: 0.3 }, // D
    { note: 659, dur: 0.3 }, // E
    { note: 523, dur: 0.3 }, // C
    { note: 659, dur: 0.3 }, // E
    { note: 698, dur: 0.3 }, // F
    { note: 784, dur: 0.6 }, // G
    { note: 784, dur: 0.3 }, // G
    { note: 698, dur: 0.3 }, // F
    { note: 659, dur: 0.3 }, // E
    { note: 587, dur: 0.3 }, // D
    { note: 523, dur: 0.3 }, // C
    { note: 587, dur: 0.3 }, // D
    { note: 659, dur: 0.3 }, // E
    { note: 523, dur: 0.6 }, // C
  ];
  
  let noteIdx = 0;
  function playNextNote() {
    if (!musicPlaying && noteIdx > 0) return;
    const { note, dur } = melody[noteIdx % melody.length];
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.type = 'sine';
    osc.frequency.value = note;
    gain.gain.value = 0.06;
    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + dur * 0.9);
    osc.start();
    osc.stop(ctx.currentTime + dur);
    noteIdx++;
  }
  
  playNextNote();
  bgMusicInterval = setInterval(playNextNote, 350);
}

function stopMusic() {
  if (bgMusicInterval) {
    clearInterval(bgMusicInterval);
    bgMusicInterval = null;
  }
}

// ====== PWA SERVICE WORKER ======
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// Start
init();
</script>
</body>
</html>
